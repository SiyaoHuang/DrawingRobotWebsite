
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>ECE 5725 - SketchBot</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <link href="../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet"> -->

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <!-- <script src="../../assets/js/ie-emulation-modes-warning.js"></script> -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Drawing Robot</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#obj">Objective</a></li>
            <li><a href="#intro">Introduction</a></li>
            <li><a href="#design">Design</a></li>
            <li><a href="#result">Results</a></li>
            <li><a href="#conclusion">Conclusions</a></li>
            <li><a href="#future">Future Work</a></li>
            <li><a href="#parts">Parts List</a></li>
            <li><a href="#references">References</a></li>
            <li><a href="#codestuff">Code Appendix</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <div class="starter-template">
        <h1>SketchBot</h1>
        <p class="lead">ECE 5725 Final Project<br>Siyao Huang (sh2435), Daniel Kim (dsk252)</p>
      </div>

      <hr>
      <div class="center-block">
          <h4 style="text-align:center;">Demonstration Video</h4>
          <iframe width="640" height="360" src="https://www.youtube.com/embed/eXuFdh_-u_Q" allowfullscreen></iframe>
      </div>

      <hr id='obj'>

        <div class="row">
            <div style="text-align:center;">
            <h2>Objective</h2>
              <p style="text-align: left;padding: 0px 30px;">Our main objective for this project was to create a robot that could draw pictures accurately by using a camera to track its direction and position. We also wanted the robot to be fairly small so that it would fit comfortably on any size of paper as well as low cost and as simple as possible. Additionally, we wanted to provide users with some sort of interface which would display the current status of the robot as well as show a canvas of some sort on which the user could draw a picture which the robot would then draw on the paper. </p>
            </div>
        </div>
      <hr>

      <hr id="intro">

      <div style="text-align:center;">
              <h2>Introduction</h2>
              <p style="text-align: left;padding: 0px 30px;">Overall, we accomplished our objective: we implemented a small robot that could draw a picture based on input from a user interface. The robot itself has a three servos, two for the wheels and one for moving a pen up and down. The Pi camera tracks the movement of the robot by looking for three colored circles on top of the robot to determine its position and direction and the Raspberry Pi then uses this information to guide the robot from point to point. The camera can be placed (theoretically) in any orientation since we use perspective mapping to determine the 3D position of the robot. Additionally, the bot itself is standalone, requiring no external connections and has its own power supply as well as a Pi Zero. It wirelessly connects with the Raspberry Pi which communicates to the Pi Zero how the robot should move. With this system, the we are able to sketch user drawn shapes onto a paper. </p>
      </div>
    </div>


    <div class="container">
    <hr id='design'>

      <div style="text-align:center;">
              <h2>Design</h2>
              <h3>Overview</h3>
              <p style="text-align: left;padding: 0px 30px;">Because our project was fairly complex, we chose to implement standalone modules first, test to ensure the module was working correctly, then move on to implement modules that depended on this module. A high level diagram of the modules as well as the system of our robot can be seen below.</p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 349.33px;"><img alt="" src="images/image28.png" style="width: 624.00px; height: 349.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 1: A high level diagram of the software. An arrow indicates an import. </span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 302.67px;"><img alt="" src="images/image6.png" style="width: 624.00px; height: 302.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 2: High level overview of how software components work together.</span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Our system works by first allowing the user to draw points on the PiTFT. When a point is drawn, it is automatically connected to the previous point with a line. After the user completes the drawing, the controller calibrates the perspective mapping software by having the robot move around in a predetermined fashion. Position of the robot is determined by a camera and three colored dots arranged in a triangle with a fixed distance of 1 inches between the centers of the dots. The drawn array of points is then sent to the controller which guides the robot from point to point, getting input from the perspective mapping software to determine the error in the bot&rsquo;s trajectory and correct accordingly. The controller sends command packets to the Pi Zero (on the robot) via a socket connection to control the robot&rsquo;s movements. Once the points are drawn, the user can decide to draw another picture for the robot to draw or quit the program. Each of these modules is described in detail below. </p>

              <h3>Perspective Mapping</h3>
              <p style="text-align: left;padding: 0px 30px;">The perspective mapping code can be found in the file &lsquo;pmap.py&rsquo; and the main job of this module is to take in 3 points specified by pixel coordinates and convert that into 3D positions in the real world. The way this happens is by using a technique in computer graphics known as ray tracing. Essentially, the scene is modeled by a point for the camera and an image plane in front of the camera. Using this model, a 3D scene of objects can be projected onto the image plane by casting rays from the camera (the beginning point of the ray), through a pixel, and onto the scene where it will hit some object. The color of that object is then projected back onto the pixel. </p>
              <p class="c5 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Using this technique in reverse, we can cast rays from the camera to the input pixels and determine where the ray intersected the scene. Below is a diagram to make things a bit more clear:</p>
              <p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 313.33px;"><img alt="" src="images/image22.png" style="width: 624.00px; height: 313.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 3: A simple diagram of ray tracing.</span></p>
              <p class="c5 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Because we know the distance is fixed between the sides of the triangle as 1 inches, this essentially boils down to a math problem of finding the likeliest length of the 3 rays with the 1 inch constraint. We can use the following equations (note that rays are represented as unit vectors): </p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 251.50px; height: 93.88px;"><img alt="" src="images/image9.png" style="width: 251.50px; height: 93.88px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p style="text-align: left;padding: 0px 30px;">Our goal is to basically find the 
                <span class="c2">ta, tb, </span>
                  <span>and </span>
                  <span class="c2">tc</span>
                  <span>&nbsp;values that satisfies the above equations. To do this, we implemented a function that sweeps</span>
                  <span class="c2">&nbsp;ta</span>
                  <span>, calculates the other length values based on this, and selects the</span>
                  <span class="c2">&nbsp;ta</span>
                  <span class="c0">&nbsp;value that yields a triangle that is closest to an equilateral triangle with side lengths of 1 inches. As it turns out, it is not quite enough to determine the 3D position of a triangle based on only the pixel coordinates: there are two solutions for each case. This is illustrated below: </span></p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 296.00px;"><img alt="" src="images/image27.png" style="width: 624.00px; height: 296.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 4: Two possible solutions for the same pixel coordinates.</span></p>
              <p class="c4 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 394.50px; height: 367.52px;"><img alt="" src="images/image17.png" style="width: 394.50px; height: 367.52px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span>Figure 5: Graph of sweeping triangles. The y-axis here represents the error in upholding the condition that all triangle side lengths must be 1 inch and the x-axis represents the </span><span class="c2">ta</span><span class="c0">&nbsp;value. Two solutions can be seen where the error is nearly zero at x=~911 and another at x=~940.</span></p>

              <p class="c4 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Essentially, three points on a screen can be viewed as a triangle that is pointing towards you or a triangle pointing away from you. To figure out which of these was the desired solution, we needed to introduce some sort of calibration that would define the surface our robot was on and pick the triangle that was closest to the plane. Our calibration method takes a set of possible triangles and based on their surface normals, picks the surface normal that is closest to the most triangles in the set. </p>
              <p class="c3 c5"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">After the surface normal is established, future mappings become very easy since we simply need to intersect the rays with the surface to find the triangle. We can then determine the direction of the robot using the position of the three colors at each vertex of the triangle. Additionally, we use the first detected position of the robot as the origin of our coordinate system (which resides on the surface plane) and using the direction, determine plane axis vectors as well. Perspective mapping then becomes a O(1) operation and we simply need to solve the system of equations for ray intersection with the plane. We can then return the position and direction of the robot as 2D vectors. </p>
              <p class="c5 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">One more component required to make this work was to take physical measurements of the setup. We needed to define a conversion factor from pixels to inches as well as measure the distance from the camera to the image plane. To do this, we simply took a picture of a ruler with the Pi camera, measured the distance from the camera to the surface the ruler was sitting on, and got the pixel to inch conversion factor by measuring the length of the ruler in the picture in pixels. The accuracy was not very important because we were mainly concerned with relative distances rather than absolute distances between points. </p>
              <p class="c5 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">After this was completed, we tested by moving a paper on the table with three colored dots in a square in front of the camera and got the following result: </p>
              <p class="c5 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 396.50px; height: 299.28px;"><img alt="" src="images/image5.png" style="width: 396.50px; height: 299.28px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 5: Perspective mapping, moving in a square.</span></p>

              <h3>Image Processing</h3>
              <p style="text-align: left;padding: 0px 30px;">The image processing code can be found in the file &lsquo;imageprocessor.py&rsquo; and the main role of this module is to determine the position of the three colored dots on the screen in pixel coordinates by using the OpenCV library. To accomplish this, it needs to pick out the three colors reliably and ignore environmental noise that may be a similar color. We considered using LEDs since they are a light source and therefore would not be influenced by environmental factors such as dim lighting, but it turned out to be too bright for the Pi camera to detect as a color. We finally decided to print out 3 colored circles, 1 inch in diameter, on paper and place the paper on top of the robot for the camera to detect. </p>
              <p class="c5 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Our primary method of picking out the 3 circles was to use thresholding and generate binary images, one for each color. To do this, we specified the hue, saturation, and value ranges for each color and modified this across multiple tests to ensure that it worked for a wide range of environments while also minimizing the amount of noise present. Additionally, we needed to convert the input image from the standard RGB to HSV. Below is a table of the threshold ranges for each of the circles as well as the conversions to HSV:</p>
              <p class="c5 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 395.50px; height: 76.69px;"><img alt="" src="images/image10.png" style="width: 395.50px; height: 76.69px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span>Table 1: Hue, saturation, and value ranges for thresholding. (Note: hue values range from 0 to 179 while saturation and value range from 0 to 255). </span></p>
              <p class="c5 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 346.53px; height: 203.50px;"><img alt="" src="images/image11.png" style="width: 346.53px; height: 203.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 6: Equations to convert from RGB to HSV</span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 259.35px; height: 199.50px;"><img alt="" src="images/image14.jpg" style="width: 259.35px; height: 199.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 266.05px; height: 204.50px;"><img alt="" src="images/image25.jpg" style="width: 266.05px; height: 204.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 7: convert actual image from RGB to HSV</span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Much of this was trial and error, first testing for the nominal, well lit case and then moving on to shadowing the circles to see if it still worked. We found that converting to HSV helped a lot because hue would be constant regardless of the lighting conditions. One problem we encountered while testing was that depending on the time of day, there was varying levels of yellow and blue in the environment, namely a lot of blue and yellow that was highly unsaturated. To correct this, we adjusted the saturation so that those values would be cut out of the image. </p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Once binary images were produced, we needed to first filter out noise and locate the position of the three circles. To filter out noise, we first used OpenCV to find the contours of all the shapes in the binary image, and cut out contours which were below a specified size limit. We were then able to use moments to find the most circular shapes, as shown below: </p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 233.50px; height: 51.79px;"><img alt="" src="images/image8.png" style="width: 243.88px; height: 73.02px; margin-left: 0.00px; margin-top: -10.19px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 229.78px; height: 64.50px;"><img alt="" src="images/image34.png" style="width: 229.78px; height: 64.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 332.50px; height: 54.51px;"><img alt="" src="images/image18.png" style="width: 332.50px; height: 54.51px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 8: Moment equations</span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">We then got the top three candidate circles for the binary images of each color (9 total), looked every possible combination of circles, and selected the group that was most tightly packed (closest together). Once the circles were determined, we again used the moments function to determine the centers of the circles. With this process, we were able to reliably locate the three circles in any lab lighting conditions and return their centers. </p>

              <h3>Wireless Communication</h3>
              <p style="text-align: left;padding: 0px 30px;">The job of the wireless communication module, found in the &lsquo;wireless.py&rsquo; file, is to provide an interface that allows the Pi to communicate to the Pi Zero and remotely control the robot over the WiFi. It does this by establishing a TCP connection via the python socket module. The Pi acts like a server and sends commands as strings via a command code followed by a single argument for that command. The receiver then receives these commands one by one, looks up the command code, and executes the correct function on the actual robot. Below is a table of command codes we used for our robot: </p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 337.24px; height: 198.50px;"><img alt="" src="images/image29.png" style="width: 337.24px; height: 198.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Table 2: Commands and their command codes.</span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Additionally, because the receive method of our socket blocked until it received the specified number of bytes causing erratic behavior, we specified a packet size of 50 bytes and executed commands one by one with no buffer (our connection was fast enough that commands were sent almost immediately). Our main concern for this was possible latencies between the server and the robot but because our packets were fairly small, we did not experience any noticeable delays. </p>

              <h3>Bot Controller</h3>
              <p style="text-align: left;padding: 0px 30px;">The job of the robot controller is to provide a library of functions that is able to move the robot in a variety of ways and can be found in the file &lsquo;bot.py&rsquo;. The robot itself is fairly simple, consisting of only 3 continuous rotation servos, two for the wheels and one for moving the pen up and down. </p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">We first created a servo class that encapsulated functionality of a single servo. Our initial implementation consisted of using software PWM to control the servos, but we quickly realized that we needed to control the speed of the servos as accurately as possible. Due to this, we switched over to a hardware PWM implementation which greatly improved robot movement. The bot class provides several functions for moving the <span>ro</span><span class="c0">bot and their uses will be further discussed in the main controller section. Below is a table describing each function:
              </span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 424.50px; height: 249.65px;"><img alt="" src="images/image35.png" style="width: 424.50px; height: 249.65px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Table 3: Table showing all functions of the bot class.</span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">One of the main issues with the bot was getting the pen to draw reliably and as much in the center of the bot as possible. In our first iteration of the bot, the servo would push the pen down while also pushing the whole bot up so that the wheels were not touching the ground. To fix this, we needed a weight of some sort so we placed a rock on top of our bot to hold it in place. This also provided more friction between the wheels and the paper which improved mobility. Our bot can be seen in the figure below: </p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 274.56px; height: 366.50px;"><img alt="" src="images/image1.jpg" style="width: 274.56px; height: 366.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 273.65px; height: 365.50px;"><img alt="" src="images/image4.jpg" style="width: 273.65px; height: 365.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 9: Pictures of our bot. The rubber band can be seen on the right and the rock can be seen on the left, providing a weight to hold the pen down.</span></p>

              <h3>Main Controller</h3>
              <p style="text-align: left;padding: 0px 30px;">The main controller (found in the file &lsquo;controller.py&rsquo;) is responsible for using the library functions provided by the image processor, perspective mapping, and wireless bot to guide the robot from point to point. Additionally, the controller contains all of the parameters for bot movement such as servo trimming, error tolerances, bot speed, and so on.</p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">The controller first establishes a wireless connection with the bot, and calls functions that sets up static parameters of the bot including trim values for the left and right servos, pen up and pen down speed, and the length of time spent putting the pen up or down. After this, it starts a calibration routine that basically moves the bot in a predetermined sequence so that the perspective mapping software can determine the surface normal of the plane on which the bot is on. Once completed, the perspective mapping software can identify the position of the bot using the established surface normal and surface axes. The controller then starts the sequence of moving from point to point. A diagram of this process can be seen below:</p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 189.50px; height: 435.94px;"><img alt="" src="images/image24.png" style="width: 189.50px; height: 435.94px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 10: Main sequence of events to draw from point to point.</span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">As shown in Figure 10, triangle pixel coordinates are obtained from the image processor which is then passed to the perspective mapping to determine the position and direction of the bot on the surface plane and based on this information, the next movement of the bot is determined. </p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">The movement of the bot was especially difficult since drawing needed to be as accurate as possible. To accomplish a high level of accuracy, we implemented a variety of tweaks: to move to a certain target point, the bot is rotated to within a certain tolerance (fairly large, about 40 degrees) towards the target point and then is rotated thereafter in very small increments until the target direction is reached. We only rotate in one direction since the servos are not perfectly calibrated (since they were both cheap and naturally have small differences in movement speed) and may rotate inaccurately in one direction but accurately in the other. We also increment in small amounts until we have just passed the target direction which we check by looking at the sign of the cross product between the two vectors. Moving forward works the same way where we move the bot forward towards the point to within a certain radius and then move forward in small increments until the target point has been just passed. We check this by looking at the sign of the dot product between the target direction and the bot direction. </p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">Additionally, we implemented a variation of PID control (using just the proportional component) to guide the bot while it covers the distance to the target point to within a certain radius. Our error is based on the angle difference between the bot direction vector and direction vector from the bot to the target point. Based on this error, one of the servos is slowed down slightly while the other is sped up slightly to correct the error. We considered adding in the derivative and integral components but found that using only proportional worked well.</p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 334.50px; height: 280.89px;"><img alt="" src="images/image31.png" style="width: 334.50px; height: 280.89px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 11: Diagram showing error for proportional control.</span></p>
              <p class="c1 c3"><span class="c0"></span></p>
              <p style="text-align: left;padding: 0px 30px;">One of the main problems we had with the bot was the rate at which it could complete the sequence shown in Figure 10: often times, the overhead of the image processing and perspective mapping was enough for the controller to stop the bot later than desired, causing the bot to overshoot the desired location or direction. The reason we used the small rotational and forward adjustments was to correct this problem. We initially tried to decrease the servo speed but found that the slowest speed possible was still too fast for the system to catch it and stop it in time. </p>

              <h3>User Interface</h3>
              <p style="text-align: left;padding: 0px 30px;">The user interface code can be found in the file &ldquo;ui.py&rdquo; and essentially creates a simple interface on the PiTFT for the user to draw shapes. The user can use the 4 buttons to clear the drawing or quit the program (when there are no points), redo, undo, and complete the drawing and start drawing. Points can be placed on the canvas by using the touchscreen of the PiTFT. After the drawing is completed, a point array (of pixel coordinates) is passed to the controller and the bot begins drawing. The UI can be seen below:</p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 247.00px; height: 328.55px;"><img alt="" src="images/image3.jpg" style="width: 247.00px; height: 328.55px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 12: Picture of the user interface.</span></p>
              <p class="c4 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 405.29px; height: 237.50px;"><img alt="" src="images/image2.jpg" style="width: 414.86px; height: 558.45px; margin-left: 0.00px; margin-top: -149.24px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 13: Another picture of the UI. The clear button changes to a quit button when the canvas is empty.</span></p>
              <p class="c4 c3"><span class="c0"></span></p>
              <p class="c4"><span style="overflow: hidden; display: inline-block; margin: -41.97px 41.97px; border: 0.00px solid #000000; transform: rotate(4.71rad) translateZ(0px); -webkit-transform: rotate(4.71rad) translateZ(0px); width: 248.56px; height: 332.50px;"><img alt="" src="images/image21.jpg" style="width: 248.56px; height: 332.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c4"><span class="c0">Figure 14: Side button text disappears after a few seconds of not pressing any buttons.</span></p>

      </div>
    </div>

    <div class="container">
    <hr id='result'>
    

      <div style="text-align:center;">
              <h2>Results</h2>
              <p style="text-align: left;padding: 0px 30px;">Overall, our robot worked as expected: we were able to draw an image on the PiTFT, and have the robot draw a picture with fairly good accuracy, to within an inch of error. The completed robot is shown below:</p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 302.50px; height: 332.20px;"><img alt="" src="images/image1.jpg" style="width: 390.27px; height: 519.01px; margin-left: -13.32px; margin-top: -90.67px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 186.50px; height: 331.56px;"><img alt="" src="images/image30.jpg" style="width: 186.50px; height: 331.56px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 15: Completed drawing robot.</span></p>
              <p class="c13"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 285.50px; height: 380.19px;"><img alt="" src="images/image23.jpg" style="width: 285.50px; height: 380.19px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c13"><span class="c6">Figure 16: Early sketches of the drawing bot.</span></p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 285.79px; height: 381.50px;"><img alt="" src="images/image4.jpg" style="width: 285.79px; height: 381.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 287.50px; height: 384.45px;"><img alt="" src="images/image13.jpg" style="width: 287.50px; height: 384.45px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 17: Underside of the robot, showing the pen and rubber band.</span></p>
              <p style="text-align: left;padding: 0px 30px;">A great deal of time was spent optimizing various components of the robot to increase accuracy. Some of these optimizations include decreasing the resolution of the screen so that more points could be mapped per second, decreasing the packet size from the original size of 1024 bytes to 50 bytes to decrease wireless latency, implementing an O(1) version of the perspective mapping after establishing the surface normal, and tweaking the robot settings such as the speed of the servos as well as applying software trim. Our improvements over time can be seen below:</p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 394.00px; height: 245.00px;"><img alt="" src="images/image26.jpg" style="width: 400.00px; height: 301.00px; margin-left: 0.00px; margin-top: -56.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 18: drawing robot keep drawing straight line between two points. Lines on the right side are earliest lines. They gradually evolve to to the lines on the left side.</span></p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 261.00px; height: 342.00px;"><img alt="" src="images/image7.jpg" style="width: 386.00px; height: 515.00px; margin-left: -77.00px; margin-top: -64.00px; transform: rotate(0.51rad) translateZ(0px); -webkit-transform: rotate(0.51rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 19: Drawing squares and lines. Accuracy was increased over time, as seen in the lighter square in the back vs the darker square in the front. </span></p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 563.71px; height: 434.50px;"><img alt="" src="images/image33.jpg" style="width: 713.49px; height: 951.33px; margin-left: -54.88px; margin-top: -321.30px; transform: rotate(0.44rad) translateZ(0px); -webkit-transform: rotate(0.44rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 563.50px; height: 315.60px;"><img alt="" src="images/image32.jpg" style="width: 563.50px; height: 315.60px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 20: More testing, drawing a variety of shapes. </span></p>
              <p style="text-align: left;padding: 0px 30px;">Our perspective mapping also worked as expected, as seen in a previous figure and worked fairly accurately, to within less than an inch of tolerance:</p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 396.50px; height: 299.28px;"><img alt="" src="images/image5.png" style="width: 396.50px; height: 299.28px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 21: Perspective mapping a square.</span></p>
              <p style="text-align: left;padding: 0px 30px;">Implementing the constant time solution greatly increased the granularity of movements for the robot and improved our controller substantially since it could detect slight movements. Additionally, we were able to sweep triangle distances and select the one with the smallest error. Below is a figure that shows the error as well as the two solutions that intersect the x-axis:</p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 423.50px; height: 395.41px;"><img alt="" src="images/image17.png" style="width: 423.50px; height: 395.41px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 22: The y-axis represents the error in the triangles swept out by perspective mapping. As seen here, there are two solutions where the error is zero. </span></p>
              <p style="text-align: left;padding: 0px 30px;">The final implementation of our image processor worked well, effectively ignoring environmental factors such as shadows and highlights, picking out the three colors, and producing binary images:</p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 259.35px; height: 199.50px;"><img alt="" src="images/image14.jpg" style="width: 259.35px; height: 199.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 259.35px; height: 199.50px;"><img alt="" src="images/image25.jpg" style="width: 259.35px; height: 199.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 23: On the left is the original image and on the right is an HSV image encoded in RGB. Environmental factors cause highlights, and introduce extra colors such as blue hues in shadows and yellow hues on white surfaces. Red pixels can be seen in the centers of the three circles indicating that the image processor has correctly identified the centers of the circles.</span></p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 195.00px; height: 149.34px;"><img alt="" src="images/image19.jpg" style="width: 195.00px; height: 149.34px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 196.00px; height: 149.38px;"><img alt="" src="images/image15.jpg" style="width: 196.00px; height: 149.38px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 194.00px; height: 149.30px;"><img alt="" src="images/image12.jpg" style="width: 194.00px; height: 149.30px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span>Figure 24: The three binary images are shown here for yellow, blue, and green respectively. </span></p>
              <p style="text-align: left;padding: 0px 30px;">Below is the final result of the bot. It can handle points that are close together fairly well as well as ones that are far apart. Both triangles begin and end at almost the same location (within less than an inch of tolerance).:</p>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 384.07px; height: 253.50px;"><img alt="" src="images/image16.jpg" style="width: 433.38px; height: 465.68px; margin-left: -6.95px; margin-top: -118.76px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
              <p class="c1"><span class="c6">Figure 25: Some final drawings of the bot.</span></p>
      </div>
    </div>

    <div class="container">
    <hr id='conclusion'>
        <div style="text-align:center;">
                <h2>Conclusions</h2>
                <p style="text-align: left;padding: 0px 30px;">Overall, our robot worked as expected. We were able to reliably draw pictures with the camera setup and the user interface. I believe we did everything possible to optimize at the software level and our main limitations at the end were due to the hardware we used to build our robot. Our project mainly consisted of making small, incremental improvements to our software in each of the modules outlined above. For instance, for the bot module, we realized that using hardware PWM greatly improved the granularity in movement of the bot and for perspective mapping, figuring out the constant time solution to find the triangle improved granularity in the bots position and direction. If we were given this project for a second time, we would most likely try to research and invest in better components that would improve accuracy such as an encoder for the servos or camera with better lighting adjustment and resolution.</p>
        </div>
    </div>

    <div class="container">
    <hr id='future'>

      <div style="text-align:center;">
              <h2>Future Work</h2>
              <p style="text-align: left;padding: 0px 30px;">The main bottleneck for our bot was the hardware we used. Our servos were very cheap and stopped moving when close to zero speed so much of the solutions we implemented was working around the hardware. Using better servos with a higher granularity of movement would greatly improve movement accuracy. Another limitation was the resolution of our camera. In order to do reduce the latency, we can change the pi camera to a better camera with a higher frame rate to higher resolution images which would allow us to more accurately determine the position and direction of the bot. The final bottleneck is the structure of our code. Changing to a multithreaded design may decrease latency and allow more frames to be processed per second. This is especially useful if we were to use higher resolution images.</p>
              <p style="text-align: left;padding: 0px 30px;">Additionally, WiFi latency was fairly low but there were noticeable jitters when many people were on the network. Using Bluetooth for wireless connection instead of WiFi would possibly be a better solution, but we did not have the time to figure out how to use sockets using Bluetooth so we went with a WiFi connection. Another structural flaw was the mechanism to hold the pen in place. The rubber band that held the pen down would stretch out over the course of a day and start producing different results (e.g. the pen would draw faint lines). Given more time, we would have redesigned the structure to use a spring and move the pen up and down vertically rather than have it rotate down onto the paper like we did.</p>
      </div>
    </div>

    <div class="container">
    <hr id='parts'>
      <div style="font-size:18px">
              <h2>Parts List</h2>
              <p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 523.50px; height: 146.81px;"><img alt="" src="images/image20.png" style="width: 523.50px; height: 146.81px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p>
      </div>
    </div>

    <div class="container">
    <hr id="references">

      <div style="font-size:18px">
          <h2>References</h2>
          <a href="https://picamera.readthedocs.io/">PiCamera Document</a><br>
          <a href="http://www.micropik.com/PDF/SG90Servo.pdf">Tower Pro Servo Datasheet</a><br>
          <a href="http://abyz.co.uk/rpi/pigpio/">Pigpio Library</a><br>
          <a href="https://sourceforge.net/p/raspberry-gpio-python/wiki/Home/">R-Pi GPIO Document</a><br>

      </div>
    </div>

    <div class="container">
    <hr id="codestuff">

      <div class="row"></div>
      <h2>Code Appendix</h2>
        <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888"># pmath.py</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Provides vector math functions for perspective mapping</span>

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Vec3</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, x, y, z):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">=</span> <span style="color: #007020">float</span>(x)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">=</span> <span style="color: #007020">float</span>(y)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>z <span style="color: #333333">=</span> <span style="color: #007020">float</span>(z)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">clone</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> Vec3(<span style="color: #007020">self</span><span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>z)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cross</span>(<span style="color: #007020">self</span>, other):
    ax, ay, az <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>z
    bx, by, bz <span style="color: #333333">=</span> other<span style="color: #333333">.</span>x, other<span style="color: #333333">.</span>y, other<span style="color: #333333">.</span>z
    <span style="color: #008800; font-weight: bold">return</span> Vec3(ay<span style="color: #333333">*</span>bz <span style="color: #333333">-</span> az<span style="color: #333333">*</span>by, az<span style="color: #333333">*</span>bx <span style="color: #333333">-</span> ax<span style="color: #333333">*</span>bz, ax<span style="color: #333333">*</span>by <span style="color: #333333">-</span> ay<span style="color: #333333">*</span>bx)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">mag</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">**</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">**</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>z <span style="color: #333333">**</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">**</span> <span style="color: #333333">.</span><span style="color: #0000DD; font-weight: bold">5</span>

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">normalize</span>(<span style="color: #007020">self</span>):
    m <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>mag()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">/=</span> m
    <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">/=</span> m
    <span style="color: #007020">self</span><span style="color: #333333">.</span>z <span style="color: #333333">/=</span> m
    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span>

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">dist_to</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">self</span> <span style="color: #333333">-</span> other)<span style="color: #333333">.</span>mag()

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">vals</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>z)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__mul__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">type</span>(other) <span style="color: #333333">==</span> Vec3:
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">*</span> other<span style="color: #333333">.</span>x <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">*</span> other<span style="color: #333333">.</span>y <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>z <span style="color: #333333">*</span> other<span style="color: #333333">.</span>z
    <span style="color: #008800; font-weight: bold">return</span> Vec3(<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">*</span> other, <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">*</span> other, <span style="color: #007020">self</span><span style="color: #333333">.</span>z <span style="color: #333333">*</span> other)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__div__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">return</span> Vec3(<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">/</span> other, <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">/</span> other, <span style="color: #007020">self</span><span style="color: #333333">.</span>z <span style="color: #333333">/</span> other)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__add__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">assert</span> <span style="color: #007020">type</span>(other) <span style="color: #333333">==</span> Vec3
    <span style="color: #008800; font-weight: bold">return</span> Vec3(<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">+</span> other<span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">+</span> other<span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>z <span style="color: #333333">+</span> other<span style="color: #333333">.</span>z)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__sub__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">assert</span> <span style="color: #007020">type</span>(other) <span style="color: #333333">==</span> Vec3
    <span style="color: #008800; font-weight: bold">return</span> Vec3(<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">-</span> other<span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">-</span> other<span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>z <span style="color: #333333">-</span> other<span style="color: #333333">.</span>z)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__rsub__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">assert</span> <span style="color: #007020">type</span>(other) <span style="color: #333333">==</span> Vec3
    <span style="color: #008800; font-weight: bold">return</span> Vec3(other<span style="color: #333333">.</span>x <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>x, other<span style="color: #333333">.</span>y <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>y, other<span style="color: #333333">.</span>z <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>z)

  __rmul__ <span style="color: #333333">=</span> __mul__
  __radd__ <span style="color: #333333">=</span> __add__

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__str__</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&quot;&lt;</span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">, </span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">, </span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">&gt;&quot;</span> <span style="color: #333333">%</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>z)

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Vec2</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, x, y):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">=</span> <span style="color: #007020">float</span>(x)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">=</span> <span style="color: #007020">float</span>(y)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">clone</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> Vec2(<span style="color: #007020">self</span><span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cross</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">*</span> other<span style="color: #333333">.</span>y <span style="color: #333333">-</span> other<span style="color: #333333">.</span>x <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>y

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">mag</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">**</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">**</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">**</span> <span style="color: #333333">.</span><span style="color: #0000DD; font-weight: bold">5</span>

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">normalize</span>(<span style="color: #007020">self</span>):
    m <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>mag()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">/=</span> m
    <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">/=</span> m
    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span>

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">dist_to</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">self</span> <span style="color: #333333">-</span> other)<span style="color: #333333">.</span>mag()

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">vals</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__mul__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">type</span>(other) <span style="color: #333333">==</span> Vec2:
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">*</span> other<span style="color: #333333">.</span>x <span style="color: #333333">+</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">*</span> other<span style="color: #333333">.</span>y
    <span style="color: #008800; font-weight: bold">return</span> Vec2(<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">*</span> other, <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">*</span> other)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__div__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">return</span> Vec2(<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">/</span> other, <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">/</span> other)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__add__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">assert</span> <span style="color: #007020">type</span>(other) <span style="color: #333333">==</span> Vec2
    <span style="color: #008800; font-weight: bold">return</span> Vec2(<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">+</span> other<span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">+</span> other<span style="color: #333333">.</span>y)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__sub__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">assert</span> <span style="color: #007020">type</span>(other) <span style="color: #333333">==</span> Vec2
    <span style="color: #008800; font-weight: bold">return</span> Vec2(<span style="color: #007020">self</span><span style="color: #333333">.</span>x <span style="color: #333333">-</span> other<span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y <span style="color: #333333">-</span> other<span style="color: #333333">.</span>y)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__rsub__</span>(<span style="color: #007020">self</span>, other):
    <span style="color: #008800; font-weight: bold">assert</span> <span style="color: #007020">type</span>(other) <span style="color: #333333">==</span> Vec2
    <span style="color: #008800; font-weight: bold">return</span> Vec2(other<span style="color: #333333">.</span>x <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>x, other<span style="color: #333333">.</span>y <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>y)

  __rmul__ <span style="color: #333333">=</span> __mul__
  __radd__ <span style="color: #333333">=</span> __add__

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__str__</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&quot;&lt;</span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">, </span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">&gt;&quot;</span> <span style="color: #333333">%</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>y)

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">PFunction</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, f, eps):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>f <span style="color: #333333">=</span> f
    <span style="color: #007020">self</span><span style="color: #333333">.</span>eps <span style="color: #333333">=</span> eps

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__call__</span>(<span style="color: #007020">self</span>, x):
    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>f(x)

  <span style="color: #888888"># Finds the slope of the function at a certain point.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">slope</span>(<span style="color: #007020">self</span>, x):
    prev <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>f(x)
    nxt <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>f(x <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>eps)
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">None</span> <span style="color: #000000; font-weight: bold">in</span> [prev, nxt]:
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
    <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>f(x) <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>f(x <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>eps)) <span style="color: #333333">/</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>eps

  <span style="color: #888888"># Finds the end of the function in a certain range and return </span>
  <span style="color: #888888"># the input value.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">findEnd</span>(<span style="color: #007020">self</span>, a, b):
    left, right <span style="color: #333333">=</span> a, b
    <span style="color: #008800; font-weight: bold">while</span> right <span style="color: #333333">-</span> left <span style="color: #333333">&gt;</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>eps:
      middle <span style="color: #333333">=</span> (left <span style="color: #333333">+</span> right) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>f(middle) <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        right <span style="color: #333333">=</span> middle
      <span style="color: #008800; font-weight: bold">else</span>:
        left <span style="color: #333333">=</span> middle
    <span style="color: #008800; font-weight: bold">return</span> left

  <span style="color: #888888"># Finds the minimum of a function given a domain interval and</span>
  <span style="color: #888888"># returns the input value for which the function is minimum. Works</span>
  <span style="color: #888888"># only for unimodal functions.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">findMin</span>(<span style="color: #007020">self</span>, a, b):
    left, right <span style="color: #333333">=</span> a, b
    <span style="color: #008800; font-weight: bold">while</span> right <span style="color: #333333">-</span> left <span style="color: #333333">&gt;</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>eps:
      middle <span style="color: #333333">=</span> (left <span style="color: #333333">+</span> right) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      smiddle <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>slope(middle)
      <span style="color: #008800; font-weight: bold">if</span> smiddle <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
      <span style="color: #008800; font-weight: bold">if</span> smiddle <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>:
        right <span style="color: #333333">=</span> middle
      <span style="color: #008800; font-weight: bold">else</span>:
        left <span style="color: #333333">=</span> middle
    <span style="color: #008800; font-weight: bold">return</span> (left <span style="color: #333333">+</span> right) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
</pre></td></tr></table></div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888"># pmap.py</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Perspective mapping from screen coordinates to surface coordinates</span>

<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pmath</span> <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">*</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">numpy.linalg</span> <span style="color: #008800; font-weight: bold">import</span> inv

<span style="color: #888888"># constants</span>
TRIANGLE_UNITS  <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">1.0</span>
DISTANCE_TO_CAM <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">14.625</span>
P2U             <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">15.0</span> <span style="color: #333333">/</span> <span style="color: #6600EE; font-weight: bold">361.411</span>
DISTANCE_MAX    <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">100.0</span>
IMG_WIDTH       <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">416</span>
IMG_HEIGHT      <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">320</span>
PIC_WIDTH       <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">320</span>
PIC_HEIGHT      <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">240</span>

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Triangle</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, r, g, b):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>r <span style="color: #333333">=</span> r
    <span style="color: #007020">self</span><span style="color: #333333">.</span>g <span style="color: #333333">=</span> g
    <span style="color: #007020">self</span><span style="color: #333333">.</span>b <span style="color: #333333">=</span> b
    <span style="color: #007020">self</span><span style="color: #333333">.</span>center <span style="color: #333333">=</span> (r <span style="color: #333333">+</span> g <span style="color: #333333">+</span> b) <span style="color: #333333">/</span> <span style="color: #6600EE; font-weight: bold">3.0</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>normal <span style="color: #333333">=</span> (b <span style="color: #333333">-</span> r)<span style="color: #333333">.</span>cross(g <span style="color: #333333">-</span> r)<span style="color: #333333">.</span>normalize()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>direction <span style="color: #333333">=</span> (g <span style="color: #333333">-</span> (r <span style="color: #333333">+</span> b) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>)<span style="color: #333333">.</span>normalize()
  
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__str__</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&quot;[</span><span style="background-color: #eeeeee">%s</span><span style="background-color: #fff0f0">, </span><span style="background-color: #eeeeee">%s</span><span style="background-color: #fff0f0">]&quot;</span> <span style="color: #333333">%</span> (<span style="color: #007020">str</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>center), <span style="color: #007020">str</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>normal))

<span style="color: #888888"># This class provides the functions necessary to convert screen space </span>
<span style="color: #888888"># coordinates (e.g. pixel coordinates) into coordinates in the 3D world as well as</span>
<span style="color: #888888"># 2D coordinates on paper space (e.g. the plane on which the robot travels).</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Note: before perspective mapping can be utilized, the surface normal</span>
<span style="color: #888888"># must be calibrated. This is done by:</span>
<span style="color: #888888">#  self.addCalibration -&gt; ... -&gt; self.addCalibration -&gt; self.calibrateSurfaceNormal -&gt; self.initSurface</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">PMap</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, epsx, epsy):
    <span style="color: #888888"># Epsilon values</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>epsx <span style="color: #333333">=</span> epsx
    <span style="color: #007020">self</span><span style="color: #333333">.</span>epsy <span style="color: #333333">=</span> epsy

    <span style="color: #888888"># Direction vectors</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>ra <span style="color: #333333">=</span> <span style="color: #007020">None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rb <span style="color: #333333">=</span> <span style="color: #007020">None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rc <span style="color: #333333">=</span> <span style="color: #007020">None</span>

    <span style="color: #888888"># Surface variables</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrate <span style="color: #333333">=</span> []
    <span style="color: #007020">self</span><span style="color: #333333">.</span>start <span style="color: #333333">=</span> <span style="color: #007020">None</span> <span style="color: #888888">#Vec3(-4.001322, -1.373553, 10.475298)#None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceNormal <span style="color: #333333">=</span> <span style="color: #007020">None</span> <span style="color: #888888">#Vec3(0.105336, 0.112570, -0.983134)#None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX <span style="color: #333333">=</span> <span style="color: #007020">None</span> <span style="color: #888888">#Vec3(-0.994370, 0.016962, -0.104598)#None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY <span style="color: #333333">=</span> <span style="color: #007020">None</span> <span style="color: #888888">#Vec3(0.004925, 0.993437, 0.114278)#None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>framex <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.15</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>framey <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.15</span>

  <span style="color: #888888"># Input vectors in pixel coordinates</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">setPoints</span>(<span style="color: #007020">self</span>, p1, p2, p3):
    p1x, p1y <span style="color: #333333">=</span> p1
    p2x, p2y <span style="color: #333333">=</span> p2
    p3x, p3y <span style="color: #333333">=</span> p3

    <span style="color: #888888"># Transform pixel coordinates to be centered at the origin</span>
    p1x, p1y <span style="color: #333333">=</span> p1x <span style="color: #333333">-</span> <span style="color: #007020">float</span>(IMG_WIDTH <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>), <span style="color: #007020">float</span>(IMG_HEIGHT <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">-</span> p1y
    p2x, p2y <span style="color: #333333">=</span> p2x <span style="color: #333333">-</span> <span style="color: #007020">float</span>(IMG_WIDTH <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>), <span style="color: #007020">float</span>(IMG_HEIGHT <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">-</span> p2y
    p3x, p3y <span style="color: #333333">=</span> p3x <span style="color: #333333">-</span> <span style="color: #007020">float</span>(IMG_WIDTH <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>), <span style="color: #007020">float</span>(IMG_HEIGHT <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">-</span> p3y

    <span style="color: #888888"># Convert pixels to units and set z coordinate</span>
    p1 <span style="color: #333333">=</span> P2U <span style="color: #333333">*</span> Vec3(p1x, p1y, <span style="color: #6600EE; font-weight: bold">0.0</span>)
    p2 <span style="color: #333333">=</span> P2U <span style="color: #333333">*</span> Vec3(p2x, p2y, <span style="color: #6600EE; font-weight: bold">0.0</span>)
    p3 <span style="color: #333333">=</span> P2U <span style="color: #333333">*</span> Vec3(p3x, p3y, <span style="color: #6600EE; font-weight: bold">0.0</span>)
    p1<span style="color: #333333">.</span>z <span style="color: #333333">=</span> DISTANCE_TO_CAM
    p2<span style="color: #333333">.</span>z <span style="color: #333333">=</span> DISTANCE_TO_CAM
    p3<span style="color: #333333">.</span>z <span style="color: #333333">=</span> DISTANCE_TO_CAM

    <span style="color: #888888"># Normalize and use as direction vectors</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>ra <span style="color: #333333">=</span> p1<span style="color: #333333">.</span>normalize()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rb <span style="color: #333333">=</span> p2<span style="color: #333333">.</span>normalize()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rc <span style="color: #333333">=</span> p3<span style="color: #333333">.</span>normalize()

  <span style="color: #888888"># Traces out a triangle for a given ta value and returns</span>
  <span style="color: #888888"># the path that it took.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">generateDiff</span>(<span style="color: #007020">self</span>, t):
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">genHelper</span>(t, i, path):
      <span style="color: #008800; font-weight: bold">if</span> i <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span>:
        <span style="color: #008800; font-weight: bold">return</span> [path <span style="color: #333333">+</span> [t]]
      <span style="color: #008800; font-weight: bold">if</span> t <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        <span style="color: #008800; font-weight: bold">return</span> genHelper(<span style="color: #007020">None</span>, i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>, path <span style="color: #333333">+</span> [<span style="color: #007020">None</span>]) <span style="color: #333333">+</span> genHelper(<span style="color: #007020">None</span>, i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>, path <span style="color: #333333">+</span> [<span style="color: #007020">None</span>])

      rab <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>ra <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>rb
      rcb <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>rc <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>rb
      rac <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>ra <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>rc
      arr <span style="color: #333333">=</span> [rab, rcb, rac]
      left <span style="color: #333333">=</span> t <span style="color: #333333">*</span> arr[i]
      right <span style="color: #333333">=</span> t <span style="color: #333333">*</span> t <span style="color: #333333">*</span> (arr[i] <span style="color: #333333">*</span> arr[i] <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>

      <span style="color: #008800; font-weight: bold">if</span> right <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">0</span>:
        <span style="color: #008800; font-weight: bold">return</span> genHelper(<span style="color: #007020">None</span>, i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>, path <span style="color: #333333">+</span> [<span style="color: #007020">None</span>]) <span style="color: #333333">+</span> genHelper(<span style="color: #007020">None</span>, i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>, path <span style="color: #333333">+</span> [<span style="color: #007020">None</span>])

      plus <span style="color: #333333">=</span> left <span style="color: #333333">+</span> right <span style="color: #333333">**</span> <span style="color: #333333">.</span><span style="color: #0000DD; font-weight: bold">5</span>
      minus <span style="color: #333333">=</span> left <span style="color: #333333">-</span> right <span style="color: #333333">**</span> <span style="color: #333333">.</span><span style="color: #0000DD; font-weight: bold">5</span>
      <span style="color: #008800; font-weight: bold">return</span> genHelper(plus, i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>, path <span style="color: #333333">+</span> [t]) <span style="color: #333333">+</span> genHelper(minus, i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>, path <span style="color: #333333">+</span> [t])
    <span style="color: #008800; font-weight: bold">return</span> genHelper(t, <span style="color: #0000DD; font-weight: bold">0</span>, [])

  <span style="color: #888888"># Returns a function that traces a specific triangle path and returns </span>
  <span style="color: #888888"># an array containing the path that it took.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">makeTraceFunc</span>(<span style="color: #007020">self</span>, path):
    f <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">lambda</span> t: <span style="color: #007020">self</span><span style="color: #333333">.</span>generateDiff(t)[path]
    <span style="color: #008800; font-weight: bold">return</span> PFunction(f, <span style="color: #007020">self</span><span style="color: #333333">.</span>epsx)

  <span style="color: #888888"># Returns a function that traces a specific triangle path for a given</span>
  <span style="color: #888888"># ta and returns abs(ta - looped around ta)</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">makeDiffFunc</span>(<span style="color: #007020">self</span>, path):
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">f</span>(t):
      res <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>generateDiff(t)[path]
      <span style="color: #008800; font-weight: bold">if</span> res[<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">abs</span>(res[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">-</span> res[<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>])
    <span style="color: #008800; font-weight: bold">return</span> PFunction(f, <span style="color: #007020">self</span><span style="color: #333333">.</span>epsx)

  <span style="color: #888888"># Returns a function that traces a specific triangle path for a given</span>
  <span style="color: #888888"># ta and returns ta - looped around ta</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">makeSDiffFunc</span>(<span style="color: #007020">self</span>, path):
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">f</span>(t):
      res <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>generateDiff(t)[path]
      <span style="color: #008800; font-weight: bold">if</span> res[<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
      <span style="color: #008800; font-weight: bold">return</span> res[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">-</span> res[<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>]
    <span style="color: #008800; font-weight: bold">return</span> PFunction(f, <span style="color: #007020">self</span><span style="color: #333333">.</span>epsx)

  <span style="color: #888888"># Sweeps all diff function paths with a certain step size and prints out</span>
  <span style="color: #888888"># the resulting values. Can copy/paste into excel to graph. </span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">sweepTriangles</span>(<span style="color: #007020">self</span>, step):
    funcs <span style="color: #333333">=</span> []
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">8</span>):
      funcs <span style="color: #333333">+=</span> [<span style="color: #007020">self</span><span style="color: #333333">.</span>makeSDiffFunc(i)]
    
    i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    s <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;&quot;</span>
    <span style="color: #008800; font-weight: bold">while</span> i <span style="color: #333333">&lt;</span> (<span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">-</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>ra <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>rb) <span style="color: #333333">**</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">**</span> <span style="color: #333333">-.</span><span style="color: #0000DD; font-weight: bold">5</span>:
      s2 <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;&quot;</span>
      <span style="color: #008800; font-weight: bold">for</span> f <span style="color: #000000; font-weight: bold">in</span> funcs:
        res <span style="color: #333333">=</span> f(i)
        s2 <span style="color: #333333">+=</span> <span style="color: #007020">str</span>(<span style="background-color: #fff0f0">&#39; &#39;</span> <span style="color: #008800; font-weight: bold">if</span> res <span style="color: #333333">==</span> <span style="color: #007020">None</span> <span style="color: #008800; font-weight: bold">else</span> res) <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&#39;</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\t</span><span style="background-color: #fff0f0">&#39;</span>
      s <span style="color: #333333">+=</span> s2 <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&#39;</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&#39;</span>
      i <span style="color: #333333">+=</span> step
    <span style="color: #008800; font-weight: bold">print</span> s

  <span style="color: #888888"># Finds possible triangles within an epsilon value and</span>
  <span style="color: #888888"># returns array of corresponding ta, tb, and tc.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">findTriangles</span>(<span style="color: #007020">self</span>):
    mins <span style="color: #333333">=</span> []
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">8</span>):
      f <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>makeDiffFunc(i)
      trace <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>makeTraceFunc(i)
      end <span style="color: #333333">=</span> f<span style="color: #333333">.</span>findEnd(<span style="color: #6600EE; font-weight: bold">0.0</span>, DISTANCE_MAX)
      m <span style="color: #333333">=</span> f<span style="color: #333333">.</span>findMin(<span style="color: #6600EE; font-weight: bold">0.0</span>, end)
      <span style="color: #008800; font-weight: bold">if</span> m <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        <span style="color: #008800; font-weight: bold">continue</span>
      <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">None</span> <span style="color: #000000; font-weight: bold">in</span> trace(m):
        <span style="color: #008800; font-weight: bold">continue</span>
      mins <span style="color: #333333">+=</span> [(f(m), trace(m))]

    mins <span style="color: #333333">=</span> <span style="color: #007020">filter</span>(<span style="color: #008800; font-weight: bold">lambda</span> x: x[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">&lt;</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>epsy, mins)
    mins <span style="color: #333333">=</span> <span style="color: #007020">map</span>(<span style="color: #008800; font-weight: bold">lambda</span> x: x[<span style="color: #0000DD; font-weight: bold">1</span>], mins)
    triangles <span style="color: #333333">=</span> []
    <span style="color: #008800; font-weight: bold">for</span> tri <span style="color: #000000; font-weight: bold">in</span> mins:
      r, g, b, _ <span style="color: #333333">=</span> tri
      r, g, b <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>ra <span style="color: #333333">*</span> r, <span style="color: #007020">self</span><span style="color: #333333">.</span>rb <span style="color: #333333">*</span> g, <span style="color: #007020">self</span><span style="color: #333333">.</span>rc <span style="color: #333333">*</span> b
      triangles <span style="color: #333333">+=</span> [Triangle(r, g, b)]
    <span style="color: #008800; font-weight: bold">return</span> triangles

  <span style="color: #888888"># Finds triangle whose normal is closest to the established</span>
  <span style="color: #888888"># surface normal.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">getClosestTriangle</span>(<span style="color: #007020">self</span>, arr):
    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">min</span>(arr, key<span style="color: #333333">=</span><span style="color: #008800; font-weight: bold">lambda</span> t: t<span style="color: #333333">.</span>normal<span style="color: #333333">.</span>dist_to(<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceNormal))

  <span style="color: #888888"># Adds possible triangles to the calibration</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">addCalibration</span>(<span style="color: #007020">self</span>, p1, p2, p3):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>setPoints(p1, p2, p3)
    triangles <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>findTriangles()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrate <span style="color: #333333">+=</span> triangles

  <span style="color: #888888"># Given a list of triangles, finds the surface normal that is </span>
  <span style="color: #888888"># closest to all triangle normals.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">calibrateSurfaceNormal</span>(<span style="color: #007020">self</span>):
    bin1norm <span style="color: #333333">=</span> <span style="color: #007020">None</span>
    bin1pts <span style="color: #333333">=</span> []
    bin2norm <span style="color: #333333">=</span> <span style="color: #007020">None</span>
    bin2pts <span style="color: #333333">=</span> []
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrate:
      <span style="color: #008800; font-weight: bold">if</span> bin1norm <span style="color: #333333">==</span> bin2norm <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        bin1norm <span style="color: #333333">=</span> i<span style="color: #333333">.</span>normal
        bin1pts <span style="color: #333333">+=</span> [i<span style="color: #333333">.</span>center]
      <span style="color: #008800; font-weight: bold">elif</span> bin2norm <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        bin2norm <span style="color: #333333">=</span> i<span style="color: #333333">.</span>normal
        bin2pts <span style="color: #333333">+=</span> [i<span style="color: #333333">.</span>center]
      <span style="color: #008800; font-weight: bold">else</span>:
        one <span style="color: #333333">=</span> bin1norm<span style="color: #333333">.</span>dist_to(i<span style="color: #333333">.</span>normal)
        two <span style="color: #333333">=</span> bin2norm<span style="color: #333333">.</span>dist_to(i<span style="color: #333333">.</span>normal)
        <span style="color: #008800; font-weight: bold">if</span> one <span style="color: #333333">&lt;</span> two:
          bin1norm <span style="color: #333333">=</span> (bin1norm <span style="color: #333333">+</span> i<span style="color: #333333">.</span>normal) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
          bin1pts <span style="color: #333333">+=</span> [i<span style="color: #333333">.</span>center]
        <span style="color: #008800; font-weight: bold">else</span>:
          bin2norm <span style="color: #333333">=</span> (bin2norm <span style="color: #333333">+</span> i<span style="color: #333333">.</span>normal) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
          bin2pts <span style="color: #333333">+=</span> [i<span style="color: #333333">.</span>center]

    bin1 <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #007020">len</span>(bin1pts) <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span>):
      bin1 <span style="color: #333333">+=</span> <span style="color: #007020">abs</span>((bin1pts[i] <span style="color: #333333">-</span> bin1pts[i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>]) <span style="color: #333333">*</span> bin1norm)
    bin2 <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #007020">len</span>(bin2pts) <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span>):
      bin2 <span style="color: #333333">+=</span> <span style="color: #007020">abs</span>((bin2pts[i] <span style="color: #333333">-</span> bin2pts[i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>]) <span style="color: #333333">*</span> bin2norm)

    <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceNormal <span style="color: #333333">=</span> bin1norm <span style="color: #008800; font-weight: bold">if</span> bin1 <span style="color: #333333">&lt;</span> bin2 <span style="color: #008800; font-weight: bold">else</span> bin2norm

  <span style="color: #888888"># Sets starting position in 3D space</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">initSurface</span>(<span style="color: #007020">self</span>, p1, p2, p3):
    triangle <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>perspectiveMap(p1, p2, p3)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>start <span style="color: #333333">=</span> triangle<span style="color: #333333">.</span>center
    <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX <span style="color: #333333">=</span> triangle<span style="color: #333333">.</span>direction<span style="color: #333333">.</span>cross(<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceNormal)<span style="color: #333333">.</span>normalize()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceNormal<span style="color: #333333">.</span>cross(<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX)<span style="color: #333333">.</span>normalize()

  <span style="color: #888888"># Resets calibration array</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">resetCalibration</span>(<span style="color: #007020">self</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrate <span style="color: #333333">=</span> []

  <span style="color: #888888"># Finds triangle in 3D space relative to the camera.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">perspectiveMap</span>(<span style="color: #007020">self</span>, p1, p2, p3):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>setPoints(p1, p2, p3)
    ts <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>findTriangles()
    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>getClosestTriangle(ts)

  <span style="color: #888888"># Finds position on the surface plane relative to the starting position</span>
  <span style="color: #888888"># and returns 2D coordinates and the direction vector.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">surfaceMap</span>(<span style="color: #007020">self</span>, p1, p2, p3):
    triangle <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>perspectiveMap(p1, p2, p3)
    p <span style="color: #333333">=</span> triangle<span style="color: #333333">.</span>center <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>start
    position <span style="color: #333333">=</span> Vec2(<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX <span style="color: #333333">*</span> p, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY <span style="color: #333333">*</span> p)
    d <span style="color: #333333">=</span> triangle<span style="color: #333333">.</span>direction
    direction <span style="color: #333333">=</span> Vec2(<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX <span style="color: #333333">*</span> d, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY <span style="color: #333333">*</span> d)<span style="color: #333333">.</span>normalize()
    <span style="color: #008800; font-weight: bold">return</span> (position, direction)
  
  <span style="color: #888888"># Does the same thing as surfaceMap in O(1) time.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">surfaceMapFast</span>(<span style="color: #007020">self</span>, p1, p2, p3):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>setPoints(p1, p2, p3)
    ramat <span style="color: #333333">=</span> np<span style="color: #333333">.</span>matrix([
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>x, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>ra<span style="color: #333333">.</span>x],
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>y, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>ra<span style="color: #333333">.</span>y],
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>z, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>z, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>ra<span style="color: #333333">.</span>z]
    ])
    rbmat <span style="color: #333333">=</span> np<span style="color: #333333">.</span>matrix([
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>x, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>rb<span style="color: #333333">.</span>x],
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>y, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>rb<span style="color: #333333">.</span>y],
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>z, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>z, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>rb<span style="color: #333333">.</span>z]
    ])
    rcmat <span style="color: #333333">=</span> np<span style="color: #333333">.</span>matrix([
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>x, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>rc<span style="color: #333333">.</span>x],
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>y, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>rc<span style="color: #333333">.</span>y],
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>z, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>z, <span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>rc<span style="color: #333333">.</span>z]
    ])
    o <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array([[<span style="color: #007020">self</span><span style="color: #333333">.</span>start<span style="color: #333333">.</span>x], [<span style="color: #007020">self</span><span style="color: #333333">.</span>start<span style="color: #333333">.</span>y], [<span style="color: #007020">self</span><span style="color: #333333">.</span>start<span style="color: #333333">.</span>z]])
    ra <span style="color: #333333">=</span> ramat<span style="color: #333333">.</span>I <span style="color: #333333">*</span> o
    rb <span style="color: #333333">=</span> rbmat<span style="color: #333333">.</span>I <span style="color: #333333">*</span> o
    rc <span style="color: #333333">=</span> rcmat<span style="color: #333333">.</span>I <span style="color: #333333">*</span> o
    ra <span style="color: #333333">=</span> Vec2(ra[<span style="color: #0000DD; font-weight: bold">0</span>], ra[<span style="color: #0000DD; font-weight: bold">1</span>])
    rb <span style="color: #333333">=</span> Vec2(rb[<span style="color: #0000DD; font-weight: bold">0</span>], rb[<span style="color: #0000DD; font-weight: bold">1</span>])
    rc <span style="color: #333333">=</span> Vec2(rc[<span style="color: #0000DD; font-weight: bold">0</span>], rc[<span style="color: #0000DD; font-weight: bold">1</span>])
    position <span style="color: #333333">=</span> (ra <span style="color: #333333">+</span> rb <span style="color: #333333">+</span> rc) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">3</span>
    direction <span style="color: #333333">=</span> (rb <span style="color: #333333">-</span> (ra <span style="color: #333333">+</span> rc) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>)<span style="color: #333333">.</span>normalize()
    <span style="color: #008800; font-weight: bold">return</span> (position, direction)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">surfaceMapSingle</span>(<span style="color: #007020">self</span>, p):
    px, py <span style="color: #333333">=</span> p

    <span style="color: #888888"># Transform pixel coordinates to be centered at the origin</span>
    px, py <span style="color: #333333">=</span> px <span style="color: #333333">-</span> <span style="color: #007020">float</span>(IMG_WIDTH <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>), <span style="color: #007020">float</span>(IMG_HEIGHT <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">-</span> py

    <span style="color: #888888"># Convert pixels to units and set z coordinate</span>
    p <span style="color: #333333">=</span> P2U <span style="color: #333333">*</span> Vec3(px, py, <span style="color: #6600EE; font-weight: bold">0.0</span>)
    p<span style="color: #333333">.</span>z <span style="color: #333333">=</span> DISTANCE_TO_CAM

    <span style="color: #888888"># Normalize and use as direction vectors</span>
    r <span style="color: #333333">=</span> p<span style="color: #333333">.</span>normalize()

    <span style="color: #888888"># Intersect with surface</span>
    rmat <span style="color: #333333">=</span> np<span style="color: #333333">.</span>matrix([
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>x, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>x, <span style="color: #333333">-</span>r<span style="color: #333333">.</span>x],
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>y, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>y, <span style="color: #333333">-</span>r<span style="color: #333333">.</span>y],
      [<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceX<span style="color: #333333">.</span>z, <span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceY<span style="color: #333333">.</span>z, <span style="color: #333333">-</span>r<span style="color: #333333">.</span>z]
    ])
    o <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array([[<span style="color: #007020">self</span><span style="color: #333333">.</span>start<span style="color: #333333">.</span>x], [<span style="color: #007020">self</span><span style="color: #333333">.</span>start<span style="color: #333333">.</span>y], [<span style="color: #007020">self</span><span style="color: #333333">.</span>start<span style="color: #333333">.</span>z]])
    r <span style="color: #333333">=</span> rmat<span style="color: #333333">.</span>I <span style="color: #333333">*</span> o
    <span style="color: #008800; font-weight: bold">return</span> Vec2(r[<span style="color: #0000DD; font-weight: bold">0</span>], r[<span style="color: #0000DD; font-weight: bold">1</span>])

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">findBounds</span>(<span style="color: #007020">self</span>):
    <span style="color: #888888"># Get 2D coordinates of edges of the screen</span>
    points <span style="color: #333333">=</span> [
      (        <span style="color: #0000DD; font-weight: bold">0</span>, IMG_HEIGHT),
      (        <span style="color: #0000DD; font-weight: bold">0</span>,          <span style="color: #0000DD; font-weight: bold">0</span>),
      (IMG_WIDTH,          <span style="color: #0000DD; font-weight: bold">0</span>),
      (IMG_WIDTH, IMG_HEIGHT)
    ]
    points <span style="color: #333333">=</span> <span style="color: #007020">map</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>surfaceMapSingle, points)
    bl, tl, tr, br <span style="color: #333333">=</span> points

    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;bl&quot;</span>, bl
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;tl&quot;</span>, tl
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;tr&quot;</span>, tr
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;br&quot;</span>, br
    <span style="color: #008800; font-weight: bold">print</span>

    <span style="color: #888888"># Find bounds and adjust</span>
    bl<span style="color: #333333">.</span>x <span style="color: #333333">=</span> <span style="color: #007020">max</span>(bl<span style="color: #333333">.</span>x, tl<span style="color: #333333">.</span>x)
    tl<span style="color: #333333">.</span>x <span style="color: #333333">=</span> <span style="color: #007020">max</span>(bl<span style="color: #333333">.</span>x, tl<span style="color: #333333">.</span>x)
    tr<span style="color: #333333">.</span>x <span style="color: #333333">=</span> <span style="color: #007020">min</span>(tr<span style="color: #333333">.</span>x, br<span style="color: #333333">.</span>x)
    br<span style="color: #333333">.</span>x <span style="color: #333333">=</span> <span style="color: #007020">min</span>(tr<span style="color: #333333">.</span>x, br<span style="color: #333333">.</span>x)
    tl<span style="color: #333333">.</span>y <span style="color: #333333">=</span> <span style="color: #007020">max</span>(tl<span style="color: #333333">.</span>y, tr<span style="color: #333333">.</span>y)
    tr<span style="color: #333333">.</span>y <span style="color: #333333">=</span> <span style="color: #007020">max</span>(tl<span style="color: #333333">.</span>y, tr<span style="color: #333333">.</span>y)
    bl<span style="color: #333333">.</span>y <span style="color: #333333">=</span> <span style="color: #007020">min</span>(bl<span style="color: #333333">.</span>y, br<span style="color: #333333">.</span>y)
    br<span style="color: #333333">.</span>y <span style="color: #333333">=</span> <span style="color: #007020">min</span>(bl<span style="color: #333333">.</span>y, br<span style="color: #333333">.</span>y)

    xoffset <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>framex <span style="color: #333333">*</span> <span style="color: #007020">abs</span>(bl<span style="color: #333333">.</span>x <span style="color: #333333">-</span> br<span style="color: #333333">.</span>x)
    yoffset <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>framey <span style="color: #333333">*</span> <span style="color: #007020">abs</span>(bl<span style="color: #333333">.</span>y <span style="color: #333333">-</span> tl<span style="color: #333333">.</span>y)
    bloffset <span style="color: #333333">=</span> Vec2(xoffset, <span style="color: #333333">-</span>yoffset)
    troffset <span style="color: #333333">=</span> Vec2(<span style="color: #333333">-</span>xoffset, yoffset)

    <span style="color: #008800; font-weight: bold">return</span> bl <span style="color: #333333">+</span> bloffset, tr <span style="color: #333333">+</span> troffset

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">mapPicture</span>(<span style="color: #007020">self</span>, points):
    <span style="color: #888888"># Fit picture space into the bounds of the surface</span>
    bl, tr <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>findBounds()
    width, height <span style="color: #333333">=</span> <span style="color: #007020">abs</span>(bl<span style="color: #333333">.</span>x <span style="color: #333333">-</span> tr<span style="color: #333333">.</span>x), <span style="color: #007020">abs</span>(bl<span style="color: #333333">.</span>y <span style="color: #333333">-</span> tr<span style="color: #333333">.</span>y)
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">float</span>(width) <span style="color: #333333">/</span> height <span style="color: #333333">&gt;</span> <span style="color: #007020">float</span>(PIC_WIDTH) <span style="color: #333333">/</span> PIC_HEIGHT:
      width <span style="color: #333333">=</span> height <span style="color: #333333">*</span> (<span style="color: #007020">float</span>(PIC_WIDTH) <span style="color: #333333">/</span> PIC_HEIGHT)
    <span style="color: #008800; font-weight: bold">else</span>:
      height <span style="color: #333333">=</span> width <span style="color: #333333">*</span> (<span style="color: #007020">float</span>(PIC_HEIGHT) <span style="color: #333333">/</span> PIC_WIDTH)

    <span style="color: #008800; font-weight: bold">print</span> PIC_WIDTH, PIC_HEIGHT
    <span style="color: #008800; font-weight: bold">print</span> width, height
    tr <span style="color: #333333">=</span> bl <span style="color: #333333">+</span> Vec2(width, <span style="color: #333333">-</span>height)

    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;bl:&quot;</span>, bl
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;tr:&quot;</span>, tr
    <span style="color: #888888"># Convert pixel points into surface coordinates</span>
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #007020">len</span>(points)):
      x, y <span style="color: #333333">=</span> points[i]
      x, y <span style="color: #333333">=</span> bl<span style="color: #333333">.</span>x <span style="color: #333333">+</span> x <span style="color: #333333">*</span> width <span style="color: #333333">/</span> PIC_WIDTH, bl<span style="color: #333333">.</span>y <span style="color: #333333">-</span> (PIC_HEIGHT <span style="color: #333333">-</span> y) <span style="color: #333333">*</span> height <span style="color: #333333">/</span> PIC_HEIGHT
      points[i] <span style="color: #333333">=</span> Vec2(x, y)

    <span style="color: #008800; font-weight: bold">return</span> points
</pre></td></tr></table></div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888"># imageprocessor.py</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Image processing to determine location of three circles on the screen</span>
<span style="color: #888888"># in pixel coordinates.</span>

<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">cv2</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">picamera.array</span> <span style="color: #008800; font-weight: bold">import</span> PiRGBArray
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">picamera</span> <span style="color: #008800; font-weight: bold">import</span> PiCamera
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">imutils</span>

<span style="color: #888888"># Image thresholding constants</span>
YMIN, YMAX   <span style="color: #333333">=</span>  <span style="color: #0000DD; font-weight: bold">23</span>,  <span style="color: #0000DD; font-weight: bold">40</span>
GMIN, GMAX   <span style="color: #333333">=</span>  <span style="color: #0000DD; font-weight: bold">45</span>,  <span style="color: #0000DD; font-weight: bold">80</span>
BMIN, BMAX   <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">100</span>, <span style="color: #0000DD; font-weight: bold">120</span>
SYMIN, SYMAX <span style="color: #333333">=</span>  <span style="color: #0000DD; font-weight: bold">70</span>, <span style="color: #0000DD; font-weight: bold">255</span>
SGMIN, SGMAX <span style="color: #333333">=</span>  <span style="color: #0000DD; font-weight: bold">30</span>, <span style="color: #0000DD; font-weight: bold">255</span>
SBMIN, SBMAX <span style="color: #333333">=</span>  <span style="color: #0000DD; font-weight: bold">70</span>, <span style="color: #0000DD; font-weight: bold">255</span>
VYMIN, VYMAX <span style="color: #333333">=</span>  <span style="color: #0000DD; font-weight: bold">60</span>, <span style="color: #0000DD; font-weight: bold">255</span>
VGMIN, VGMAX <span style="color: #333333">=</span>   <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>
VBMIN, VBMAX <span style="color: #333333">=</span>   <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>
SIZEMIN      <span style="color: #333333">=</span>  <span style="color: #0000DD; font-weight: bold">20</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">15</span> <span style="color: #333333">/</span> <span style="color: #6600EE; font-weight: bold">4.0</span>
SIZEMAX      <span style="color: #333333">=</span>  <span style="color: #0000DD; font-weight: bold">70</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">60</span>

<span style="color: #888888"># Camera constants</span>
RES          <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">416</span>, <span style="color: #0000DD; font-weight: bold">320</span>
FRAMERATE    <span style="color: #333333">=</span>       <span style="color: #0000DD; font-weight: bold">30</span>

<span style="color: #888888"># This class handles all image processing including taking a picture</span>
<span style="color: #888888"># with the Raspberry Pi camera as well as performing the image processing </span>
<span style="color: #888888"># necessary to locate the centers of the yellow, green, and blue circles.</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">ImageProcessor</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>cam <span style="color: #333333">=</span> PiCamera()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>cam<span style="color: #333333">.</span>resolution <span style="color: #333333">=</span> RES
    <span style="color: #007020">self</span><span style="color: #333333">.</span>cam<span style="color: #333333">.</span>framerate <span style="color: #333333">=</span> FRAMERATE
    <span style="color: #007020">self</span><span style="color: #333333">.</span>raw <span style="color: #333333">=</span> PiRGBArray(<span style="color: #007020">self</span><span style="color: #333333">.</span>cam, size<span style="color: #333333">=</span>RES)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>write <span style="color: #333333">=</span> <span style="color: #007020">False</span>
    
    <span style="color: #007020">self</span><span style="color: #333333">.</span>counter <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>

  <span style="color: #888888"># Takes an image and returns it as a numpy array.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">getImage</span>(<span style="color: #007020">self</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>cam<span style="color: #333333">.</span>capture(<span style="color: #007020">self</span><span style="color: #333333">.</span>raw, format<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;bgr&#39;</span>, use_video_port<span style="color: #333333">=</span><span style="color: #007020">True</span>)
    arr <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>raw<span style="color: #333333">.</span>array
    <span style="color: #007020">self</span><span style="color: #333333">.</span>raw<span style="color: #333333">.</span>truncate(<span style="color: #0000DD; font-weight: bold">0</span>)
    <span style="color: #008800; font-weight: bold">return</span> arr

  <span style="color: #888888"># Returns number of pixels in the contour.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">checkSize</span>(<span style="color: #007020">self</span>, c):
    <span style="color: #008800; font-weight: bold">return</span> SIZEMAX <span style="color: #333333">&gt;</span> cv2<span style="color: #333333">.</span>moments(c)[<span style="background-color: #fff0f0">&#39;m00&#39;</span>] <span style="color: #333333">&gt;</span> SIZEMIN <span style="color: #000000; font-weight: bold">and</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>getShape(c) <span style="color: #333333">&lt;</span> <span style="color: #6600EE; font-weight: bold">0.5</span>

  <span style="color: #888888"># Returns how close to a circle the contour is, with 0 being</span>
  <span style="color: #888888"># a perfect circle.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">getShape</span>(<span style="color: #007020">self</span>, c):
    m <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>moments(c)
    shapex <span style="color: #333333">=</span> m[<span style="background-color: #fff0f0">&#39;nu20&#39;</span>]
    shapey <span style="color: #333333">=</span> m[<span style="background-color: #fff0f0">&#39;nu02&#39;</span>]
    <span style="color: #008800; font-weight: bold">return</span> shapex <span style="color: #333333">+</span> shapey

  <span style="color: #888888"># Returns pixel coordinates of the center of the contour.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">getCenter</span>(<span style="color: #007020">self</span>, c):
    m <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>moments(c)
    cx <span style="color: #333333">=</span> <span style="color: #007020">int</span>(m[<span style="background-color: #fff0f0">&#39;m10&#39;</span>]<span style="color: #333333">/</span>m[<span style="background-color: #fff0f0">&#39;m00&#39;</span>])
    cy <span style="color: #333333">=</span> <span style="color: #007020">int</span>(m[<span style="background-color: #fff0f0">&#39;m01&#39;</span>]<span style="color: #333333">/</span>m[<span style="background-color: #fff0f0">&#39;m00&#39;</span>])
    <span style="color: #008800; font-weight: bold">return</span> (cx, cy)
  
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">pixelDistance</span>(<span style="color: #007020">self</span>, a, b):
    <span style="color: #008800; font-weight: bold">return</span> ((<span style="color: #007020">float</span>(a[<span style="color: #0000DD; font-weight: bold">0</span>]) <span style="color: #333333">-</span> b[<span style="color: #0000DD; font-weight: bold">0</span>]) <span style="color: #333333">**</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">+</span> (<span style="color: #007020">float</span>(a[<span style="color: #0000DD; font-weight: bold">1</span>]) <span style="color: #333333">-</span> b[<span style="color: #0000DD; font-weight: bold">1</span>]) <span style="color: #333333">**</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">**</span> <span style="color: #333333">.</span><span style="color: #0000DD; font-weight: bold">5</span>

  <span style="color: #888888"># Takes a picture and returns the pixel coordinates of the yellow, </span>
  <span style="color: #888888"># green, and blue circles respectively. Returns None if it is unable </span>
  <span style="color: #888888"># to find one or more of the circles.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">getPoints</span>(<span style="color: #007020">self</span>):
    <span style="color: #888888"># read in image and threshold to get binary images</span>
    imagergb <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>getImage()
    image <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(imagergb, cv2<span style="color: #333333">.</span>COLOR_BGR2HSV)
    masky <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>inRange(image, np<span style="color: #333333">.</span>array([YMIN,SYMIN,VYMIN]),np<span style="color: #333333">.</span>array([YMAX,SYMAX,VYMAX]))
    maskg <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>inRange(image, np<span style="color: #333333">.</span>array([GMIN,SGMIN,VGMIN]),np<span style="color: #333333">.</span>array([GMAX,SGMAX,VGMAX]))
    maskb <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>inRange(image, np<span style="color: #333333">.</span>array([BMIN,SBMIN,VBMIN]),np<span style="color: #333333">.</span>array([BMAX,SBMAX,VBMAX]))

    <span style="color: #888888"># image processing to find center of yellow, green, and blue circles</span>
    cntsy <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>findContours(masky<span style="color: #333333">.</span>copy(), cv2<span style="color: #333333">.</span>RETR_EXTERNAL, cv2<span style="color: #333333">.</span>CHAIN_APPROX_SIMPLE)
    cntsy <span style="color: #333333">=</span> cntsy[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #008800; font-weight: bold">if</span> imutils<span style="color: #333333">.</span>is_cv2() <span style="color: #008800; font-weight: bold">else</span> cntsy[<span style="color: #0000DD; font-weight: bold">1</span>]
    cntsy <span style="color: #333333">=</span> <span style="color: #007020">filter</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>checkSize, cntsy)
    <span style="color: #008800; font-weight: bold">if</span> cntsy <span style="color: #333333">==</span> []:
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
    cntsy <span style="color: #333333">=</span> <span style="color: #007020">sorted</span>(cntsy, key<span style="color: #333333">=</span><span style="color: #007020">self</span><span style="color: #333333">.</span>getShape)

    cntsg <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>findContours(maskg<span style="color: #333333">.</span>copy(), cv2<span style="color: #333333">.</span>RETR_EXTERNAL, cv2<span style="color: #333333">.</span>CHAIN_APPROX_SIMPLE)
    cntsg <span style="color: #333333">=</span> cntsg[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #008800; font-weight: bold">if</span> imutils<span style="color: #333333">.</span>is_cv2() <span style="color: #008800; font-weight: bold">else</span> cntsg[<span style="color: #0000DD; font-weight: bold">1</span>]
    cntsg <span style="color: #333333">=</span> <span style="color: #007020">filter</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>checkSize, cntsg)
    <span style="color: #008800; font-weight: bold">if</span> cntsg <span style="color: #333333">==</span> []:
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
    cntsg <span style="color: #333333">=</span> <span style="color: #007020">sorted</span>(cntsg, key<span style="color: #333333">=</span><span style="color: #007020">self</span><span style="color: #333333">.</span>getShape)

    cntsb <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>findContours(maskb<span style="color: #333333">.</span>copy(), cv2<span style="color: #333333">.</span>RETR_EXTERNAL, cv2<span style="color: #333333">.</span>CHAIN_APPROX_SIMPLE)
    cntsb <span style="color: #333333">=</span> cntsb[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #008800; font-weight: bold">if</span> imutils<span style="color: #333333">.</span>is_cv2() <span style="color: #008800; font-weight: bold">else</span> cntsb[<span style="color: #0000DD; font-weight: bold">1</span>]
    cntsb <span style="color: #333333">=</span> <span style="color: #007020">filter</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>checkSize, cntsb)
    <span style="color: #008800; font-weight: bold">if</span> cntsb <span style="color: #333333">==</span> []:
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
    cntsb <span style="color: #333333">=</span> <span style="color: #007020">sorted</span>(cntsb, key<span style="color: #333333">=</span><span style="color: #007020">self</span><span style="color: #333333">.</span>getShape)
    
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">len</span>(cntsy) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #000000; font-weight: bold">or</span> <span style="color: #007020">len</span>(cntsg) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #000000; font-weight: bold">or</span> <span style="color: #007020">len</span>(cntsb) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>:
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>

    <span style="color: #888888"># Compare distances</span>
    m <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pixelDistance((<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>), RES)
    triple <span style="color: #333333">=</span> <span style="color: #007020">None</span>
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> cntsy[:<span style="color: #0000DD; font-weight: bold">3</span>]:
      <span style="color: #008800; font-weight: bold">for</span> j <span style="color: #000000; font-weight: bold">in</span> cntsg[:<span style="color: #0000DD; font-weight: bold">3</span>]:
        <span style="color: #008800; font-weight: bold">for</span> k <span style="color: #000000; font-weight: bold">in</span> cntsb[:<span style="color: #0000DD; font-weight: bold">3</span>]:
          ic <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>getCenter(i)
          jc <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>getCenter(j)
          kc <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>getCenter(k)
          ij <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pixelDistance(ic, jc)
          jk <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pixelDistance(jc, kc)
          ki <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pixelDistance(kc, ic)
          <span style="color: #008800; font-weight: bold">if</span> ij <span style="color: #333333">+</span> jk <span style="color: #333333">+</span> ki <span style="color: #333333">&lt;</span> m:
            m <span style="color: #333333">=</span> ij <span style="color: #333333">+</span> jk <span style="color: #333333">+</span> ki
            triple <span style="color: #333333">=</span> (ic, jc, kc)

    <span style="color: #888888"># Write to file if self.write is true</span>
    y, g, b <span style="color: #333333">=</span> triple
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>write:
      imagergb <span style="color: #333333">=</span> imagergb<span style="color: #333333">.</span>copy()
      imagergb[y[<span style="color: #0000DD; font-weight: bold">1</span>]][y[<span style="color: #0000DD; font-weight: bold">0</span>]] <span style="color: #333333">=</span> [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>]
      imagergb[g[<span style="color: #0000DD; font-weight: bold">1</span>]][g[<span style="color: #0000DD; font-weight: bold">0</span>]] <span style="color: #333333">=</span> [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>]
      imagergb[b[<span style="color: #0000DD; font-weight: bold">1</span>]][b[<span style="color: #0000DD; font-weight: bold">0</span>]] <span style="color: #333333">=</span> [<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>]
      cv2<span style="color: #333333">.</span>imwrite(<span style="background-color: #fff0f0">&quot;../data/imagergb</span><span style="background-color: #eeeeee">%i</span><span style="background-color: #fff0f0">.jpg&quot;</span> <span style="color: #333333">%</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>counter,imagergb)
      cv2<span style="color: #333333">.</span>imwrite(<span style="background-color: #fff0f0">&quot;../data/image</span><span style="background-color: #eeeeee">%i</span><span style="background-color: #fff0f0">.jpg&quot;</span> <span style="color: #333333">%</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>counter,image)
      cv2<span style="color: #333333">.</span>imwrite(<span style="background-color: #fff0f0">&quot;../data/masky</span><span style="background-color: #eeeeee">%i</span><span style="background-color: #fff0f0">.jpg&quot;</span> <span style="color: #333333">%</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>counter,masky)
      cv2<span style="color: #333333">.</span>imwrite(<span style="background-color: #fff0f0">&quot;../data/maskg</span><span style="background-color: #eeeeee">%i</span><span style="background-color: #fff0f0">.jpg&quot;</span> <span style="color: #333333">%</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>counter,maskg)
      cv2<span style="color: #333333">.</span>imwrite(<span style="background-color: #fff0f0">&quot;../data/maskb</span><span style="background-color: #eeeeee">%i</span><span style="background-color: #fff0f0">.jpg&quot;</span> <span style="color: #333333">%</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>counter,maskb)
      <span style="color: #007020">self</span><span style="color: #333333">.</span>counter <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>

    <span style="color: #008800; font-weight: bold">return</span> triple
</pre></td></tr></table></div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888"># wireless.py</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Wireless interface for the bot.</span>

<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">socket</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">bot</span> <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">*</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">sys</span>

<span style="color: #888888"># Commands</span>
BOT_FORWARD        <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
BOT_ROTATE         <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
BOT_STOP           <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">2</span>
BOT_ADJUST         <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">3</span>
BOT_PENUP          <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">4</span>
BOT_PENDOWN        <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5</span>
BOT_ROTATE_ADJUST  <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">6</span>
BOT_FORWARD_ADJUST <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">7</span>
BOT_TRIM_LEFT      <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">8</span>
BOT_TRIM_RIGHT     <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">9</span>
BOT_PU_SLEEP       <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">10</span>
BOT_PD_SLEEP       <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">11</span>

<span style="color: #888888"># Comm constants</span>
PACKET_SIZE        <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">50</span>
IP_ADDR            <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;192.168.43.28&#39;</span>
PORT               <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5005</span>

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">VirtualBotTX</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, ip<span style="color: #333333">=</span>IP_ADDR, port<span style="color: #333333">=</span>PORT):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pen <span style="color: #333333">=</span> <span style="color: #007020">False</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>s <span style="color: #333333">=</span> socket<span style="color: #333333">.</span>socket(socket<span style="color: #333333">.</span>AF_INET, socket<span style="color: #333333">.</span>SOCK_STREAM)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>s<span style="color: #333333">.</span>setsockopt(socket<span style="color: #333333">.</span>SOL_SOCKET, socket<span style="color: #333333">.</span>SO_REUSEADDR, <span style="color: #0000DD; font-weight: bold">1</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>s<span style="color: #333333">.</span>setsockopt(socket<span style="color: #333333">.</span>IPPROTO_TCP, socket<span style="color: #333333">.</span>TCP_NODELAY, <span style="color: #0000DD; font-weight: bold">1</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>s<span style="color: #333333">.</span>bind((ip, port))
    <span style="color: #007020">self</span><span style="color: #333333">.</span>s<span style="color: #333333">.</span>listen(<span style="color: #0000DD; font-weight: bold">1</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>conn, <span style="color: #007020">self</span><span style="color: #333333">.</span>addr <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>s<span style="color: #333333">.</span>accept()
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Connected to bot!&quot;</span>

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">close</span>(<span style="color: #007020">self</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>conn<span style="color: #333333">.</span>close()

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">sendCommand</span>(<span style="color: #007020">self</span>, cmd, arg):
    <span style="color: #888888"># Build and send packet</span>
    packet <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;</span><span style="background-color: #eeeeee">%i</span><span style="background-color: #fff0f0"> </span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">&quot;</span> <span style="color: #333333">%</span> (cmd, arg)
    packet <span style="color: #333333">+=</span> <span style="background-color: #fff0f0">&quot; &quot;</span> <span style="color: #333333">*</span> (PACKET_SIZE <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">-</span> <span style="color: #007020">len</span>(packet)) <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&#39;</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&#39;</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>conn<span style="color: #333333">.</span>send(packet)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">rotate</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_ROTATE, i)
  
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">rotateAdjust</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_ROTATE_ADJUST, i)
    time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.25</span>)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">forward</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_FORWARD, i)
  
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">forwardAdjust</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_FORWARD_ADJUST, i)
    time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.25</span>)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">adjust</span>(<span style="color: #007020">self</span>, dx):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_ADJUST, dx)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">penDown</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_PENDOWN, i)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pen <span style="color: #333333">=</span> <span style="color: #007020">True</span>
    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">2</span>)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">penUp</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_PENUP, i)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pen <span style="color: #333333">=</span> <span style="color: #007020">False</span>
    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">2</span>)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">penDownSleep</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_PD_SLEEP, i)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">penUpSleep</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_PU_SLEEP, i)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">trimLeft</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_TRIM_LEFT, i)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">trimRight</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_TRIM_RIGHT, i)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">stop</span>(<span style="color: #007020">self</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>sendCommand(BOT_STOP, <span style="color: #0000DD; font-weight: bold">0</span>)

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">VirtualBotRX</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, ip<span style="color: #333333">=</span>IP_ADDR, port<span style="color: #333333">=</span>PORT):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>s <span style="color: #333333">=</span> <span style="color: #007020">None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>ip <span style="color: #333333">=</span> ip
    <span style="color: #007020">self</span><span style="color: #333333">.</span>port <span style="color: #333333">=</span> port
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot <span style="color: #333333">=</span> Bot()
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&#39;Connected to Pi!&#39;</span>

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">connect</span>(<span style="color: #007020">self</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>s <span style="color: #333333">=</span> socket<span style="color: #333333">.</span>socket(socket<span style="color: #333333">.</span>AF_INET, socket<span style="color: #333333">.</span>SOCK_STREAM)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>s<span style="color: #333333">.</span>connect((<span style="color: #007020">self</span><span style="color: #333333">.</span>ip, <span style="color: #007020">self</span><span style="color: #333333">.</span>port))

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">getCommand</span>(<span style="color: #007020">self</span>):
    line <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>s<span style="color: #333333">.</span>recv(<span style="color: #0000DD; font-weight: bold">50</span>)
    <span style="color: #008800; font-weight: bold">if</span> line <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;&#39;</span>:
      <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
    cmd, arg <span style="color: #333333">=</span> line<span style="color: #333333">.</span>split()
    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">int</span>(cmd), <span style="color: #007020">float</span>(arg)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">execute</span>(<span style="color: #007020">self</span>, cmd):
    cmd, arg <span style="color: #333333">=</span> cmd
    <span style="color: #008800; font-weight: bold">if</span> cmd <span style="color: #333333">==</span> BOT_FORWARD:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_FORWARD:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>forward(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_ROTATE:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_ROTATE:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>rotate(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_STOP:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_STOP:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>stop()
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_ADJUST:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_ADJUST:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>adjust(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_PENUP:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_PENUP:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penUp(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_PENDOWN:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_PENDOWN:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penDown(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_ROTATE_ADJUST:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_ROTATE_ADJUST:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>rotateAdjust(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_FORWARD_ADJUST:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_FORWARD_ADJUST:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>forwardAdjust(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_TRIM_LEFT:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_TRIM_LEFT:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>trimLeft(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_TRIM_RIGHT:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_TRIM_RIGHT:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>trimRight(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_PD_SLEEP:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_PD_SLEEP:&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penDownSleep(arg)
    <span style="color: #008800; font-weight: bold">elif</span> cmd <span style="color: #333333">==</span> BOT_PU_SLEEP:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;BOT_PU_SLEEP&quot;</span>, arg
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penUpSleep(arg)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">run</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
      cmd <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>getCommand()
      <span style="color: #008800; font-weight: bold">if</span> cmd <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>stop()
        <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Connection closed...&quot;</span>
        <span style="color: #008800; font-weight: bold">return</span>
      <span style="color: #007020">self</span><span style="color: #333333">.</span>execute(cmd)
</pre></td></tr></table></div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888"># bot.py</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Handles controlling all bot movement.</span>

<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pigpio</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">RPi.GPIO</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">GPIO</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>

<span style="color: #888888"># Pin assignments</span>
PIN_LEFT_SERVO  <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">12</span>
PIN_RIGHT_SERVO <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">13</span>
PIN_PEN_SERVO   <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">21</span>

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Servo</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, pi, pin, <span style="color: #007020">dir</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;cw&#39;</span>, trim<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">0</span>, hw<span style="color: #333333">=</span><span style="color: #007020">True</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pin <span style="color: #333333">=</span> pin
    <span style="color: #007020">self</span><span style="color: #333333">.</span>maxspd <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.002</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>minspd <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.001</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>period <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.020</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>dir <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">dir</span> <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;cw&#39;</span> <span style="color: #008800; font-weight: bold">else</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>trim <span style="color: #333333">=</span> trim
    <span style="color: #007020">self</span><span style="color: #333333">.</span>duty <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>hw <span style="color: #333333">=</span> hw
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> hw:
      GPIO<span style="color: #333333">.</span>setup(<span style="color: #007020">self</span><span style="color: #333333">.</span>pin, GPIO<span style="color: #333333">.</span>OUT)
      <span style="color: #007020">self</span><span style="color: #333333">.</span>pwm <span style="color: #333333">=</span> GPIO<span style="color: #333333">.</span>PWM(<span style="color: #007020">self</span><span style="color: #333333">.</span>pin, <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">/</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>period)
      <span style="color: #007020">self</span><span style="color: #333333">.</span>pwm<span style="color: #333333">.</span>start(<span style="color: #0000DD; font-weight: bold">0</span>)
      <span style="color: #008800; font-weight: bold">return</span>

    <span style="color: #007020">self</span><span style="color: #333333">.</span>pi <span style="color: #333333">=</span> pi
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pi<span style="color: #333333">.</span>set_mode(<span style="color: #007020">self</span><span style="color: #333333">.</span>pin, pigpio<span style="color: #333333">.</span>OUTPUT)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pi<span style="color: #333333">.</span>hardware_PWM(<span style="color: #007020">self</span><span style="color: #333333">.</span>pin, <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">/</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>period, <span style="color: #6600EE; font-weight: bold">0.0</span>)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">turn</span>(<span style="color: #007020">self</span>, i):
    i <span style="color: #333333">+=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>trim
    i <span style="color: #333333">*=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>dir
    i <span style="color: #333333">=</span> (i <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">/</span> <span style="color: #6600EE; font-weight: bold">2.0</span>
    duty <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1000000</span> <span style="color: #333333">*</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>minspd <span style="color: #333333">+</span> i <span style="color: #333333">*</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>maxspd <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>minspd)) <span style="color: #333333">/</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>period
    duty <span style="color: #333333">=</span> <span style="color: #007020">min</span>(<span style="color: #007020">max</span>(<span style="color: #0000DD; font-weight: bold">0</span>, duty), <span style="color: #0000DD; font-weight: bold">1000000</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>duty <span style="color: #333333">=</span> duty

    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>hw:
      <span style="color: #007020">self</span><span style="color: #333333">.</span>pwm<span style="color: #333333">.</span>ChangeDutyCycle(<span style="color: #6600EE; font-weight: bold">0.0001</span> <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>duty)
      <span style="color: #008800; font-weight: bold">return</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pi<span style="color: #333333">.</span>hardware_PWM(<span style="color: #007020">self</span><span style="color: #333333">.</span>pin, <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">/</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>period, duty)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">adjustDuty</span>(<span style="color: #007020">self</span>, dx):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>hw:
      <span style="color: #008800; font-weight: bold">return</span>
    dx <span style="color: #333333">*=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>dir
    duty <span style="color: #333333">=</span> <span style="color: #007020">min</span>(<span style="color: #007020">max</span>(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #007020">self</span><span style="color: #333333">.</span>duty <span style="color: #333333">+</span> dx), <span style="color: #0000DD; font-weight: bold">1000000</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pi<span style="color: #333333">.</span>hardware_PWM(<span style="color: #007020">self</span><span style="color: #333333">.</span>pin, <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">/</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>period, duty)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">stop</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>hw:
      <span style="color: #007020">self</span><span style="color: #333333">.</span>pwm<span style="color: #333333">.</span>ChangeDutyCycle(<span style="color: #0000DD; font-weight: bold">0</span>)
      <span style="color: #008800; font-weight: bold">return</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pi<span style="color: #333333">.</span>hardware_PWM(<span style="color: #007020">self</span><span style="color: #333333">.</span>pin, <span style="color: #6600EE; font-weight: bold">0.0</span>, <span style="color: #6600EE; font-weight: bold">0.0</span>)

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Bot</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>):
    <span style="color: #888888"># initialize servos</span>
    GPIO<span style="color: #333333">.</span>setmode(GPIO<span style="color: #333333">.</span>BCM)
    pi_hw <span style="color: #333333">=</span> pigpio<span style="color: #333333">.</span>pi()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>leftServo <span style="color: #333333">=</span> Servo(pi_hw, PIN_LEFT_SERVO, <span style="background-color: #fff0f0">&#39;cw&#39;</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rightServo <span style="color: #333333">=</span> Servo(pi_hw, PIN_RIGHT_SERVO, <span style="background-color: #fff0f0">&#39;ccw&#39;</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>penServo <span style="color: #333333">=</span> Servo(pi_hw, PIN_PEN_SERVO, <span style="background-color: #fff0f0">&#39;cw&#39;</span>, hw<span style="color: #333333">=</span><span style="color: #007020">False</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pdsleep <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.0</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pusleep <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.0</span>

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">rotate</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>leftServo<span style="color: #333333">.</span>turn(i)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rightServo<span style="color: #333333">.</span>turn(<span style="color: #333333">-</span>i)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">rotateAdjust</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rotate(i)
    time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.01</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>stop()

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">forward</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>leftServo<span style="color: #333333">.</span>turn(i)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rightServo<span style="color: #333333">.</span>turn(i)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">forwardAdjust</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>forward(i)
    time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.01</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>stop()

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">adjust</span>(<span style="color: #007020">self</span>, dx):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>leftServo<span style="color: #333333">.</span>adjustDuty(dx <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rightServo<span style="color: #333333">.</span>adjustDuty(<span style="color: #333333">-</span>dx <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>)

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">penDown</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>penServo<span style="color: #333333">.</span>turn(i)
    time<span style="color: #333333">.</span>sleep(<span style="color: #007020">self</span><span style="color: #333333">.</span>pdsleep)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>penServo<span style="color: #333333">.</span>stop()

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">penUp</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>penServo<span style="color: #333333">.</span>turn(i)
    time<span style="color: #333333">.</span>sleep(<span style="color: #007020">self</span><span style="color: #333333">.</span>pusleep)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>penServo<span style="color: #333333">.</span>stop()

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">penDownSleep</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pdsleep <span style="color: #333333">=</span> i

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">penUpSleep</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pusleep <span style="color: #333333">=</span> i

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">trimLeft</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>leftServo<span style="color: #333333">.</span>trim <span style="color: #333333">=</span> i

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">trimRight</span>(<span style="color: #007020">self</span>, i):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rightServo<span style="color: #333333">.</span>trim <span style="color: #333333">=</span> i

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">stop</span>(<span style="color: #007020">self</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>leftServo<span style="color: #333333">.</span>stop()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rightServo<span style="color: #333333">.</span>stop()
</pre></td></tr></table></div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888"># controller.py</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Main controller that uses the image processor and perspective</span>
<span style="color: #888888"># mapping to control the bot via the wireless module.</span>

<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pmap</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pmap</span> <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">*</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">wireless</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">imageprocessor</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">math</span>

<span style="color: #888888"># This class provides high level actions of the robot, primarily </span>
<span style="color: #888888"># going towards a target point. It uses the image processor in</span>
<span style="color: #888888"># conjunction with the pmap class to find the robot&#39;s location </span>
<span style="color: #888888"># and control the robot accordingly. It also performs the </span>
<span style="color: #888888"># calibrations necessary to configure the pmap surface normal.</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Controller</span>(<span style="color: #007020">object</span>):
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>):
    <span style="color: #888888"># Main components</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor <span style="color: #333333">=</span> imageprocessor<span style="color: #333333">.</span>ImageProcessor()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot <span style="color: #333333">=</span> wireless<span style="color: #333333">.</span>VirtualBotTX()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap <span style="color: #333333">=</span> pmap<span style="color: #333333">.</span>PMap(epsx<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.0001</span>, epsy<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.01</span>)

    <span style="color: #888888"># Position fields</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>position <span style="color: #333333">=</span> <span style="color: #007020">None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>direction <span style="color: #333333">=</span> <span style="color: #007020">None</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>epsxy <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">1.75</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>epst <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">45</span> <span style="color: #333333">*</span> (<span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">*</span> <span style="color: #6600EE; font-weight: bold">3.141592</span> <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">360</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>epss <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.03</span>

    <span style="color: #888888"># Calibrate fields</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>framex <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.20</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>framey <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.20</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrated <span style="color: #333333">=</span> <span style="color: #007020">False</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>P <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">49200</span>

    <span style="color: #888888"># Bot parameters</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rspeed <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6600EE; font-weight: bold">0.2</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>raspeed <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6600EE; font-weight: bold">0.35</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>fspeed <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.35</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pspeed <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.1</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>upspeed <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.2</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>dnspeed <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6600EE; font-weight: bold">0.2</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>rtrim <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6600EE; font-weight: bold">0.02</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>ltrim <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pdsleep <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.4</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pusleep <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>setupBot()

  <span style="color: #888888"># Sets initial parameters of the bot</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">setupBot</span>(<span style="color: #007020">self</span>):
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>trimRight(<span style="color: #007020">self</span><span style="color: #333333">.</span>rtrim)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>trimLeft(<span style="color: #007020">self</span><span style="color: #333333">.</span>ltrim)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penDownSleep(<span style="color: #007020">self</span><span style="color: #333333">.</span>pdsleep)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penUpSleep(<span style="color: #007020">self</span><span style="color: #333333">.</span>pusleep)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penDown(<span style="color: #007020">self</span><span style="color: #333333">.</span>dnspeed)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penUp(<span style="color: #007020">self</span><span style="color: #333333">.</span>upspeed)
  
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">calibrateRoutine</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrated:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Skipping calibration.&quot;</span>
      <span style="color: #008800; font-weight: bold">return</span>

    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Establishing start position...&quot;</span>
    start <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
    <span style="color: #008800; font-weight: bold">while</span> start <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
      start <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
    p1i, p2i, p3i <span style="color: #333333">=</span> start
    <span style="color: #008800; font-weight: bold">print</span> start

    <span style="color: #888888"># Calibrate surface normal</span>
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Calibrating surface normal...&quot;</span>
    
    <span style="color: #888888"># move in a box</span>
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">8</span>):
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>forward(<span style="color: #007020">self</span><span style="color: #333333">.</span>fspeed)
      starttime <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
      <span style="color: #008800; font-weight: bold">while</span> time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> starttime <span style="color: #333333">&lt;</span> <span style="color: #6600EE; font-weight: bold">1.1</span>:
        points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
        <span style="color: #008800; font-weight: bold">if</span> points <span style="color: #333333">!=</span> <span style="color: #007020">None</span>:
          p1, p2, p3 <span style="color: #333333">=</span> points
          <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>addCalibration(p1, p2, p3)

      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>rotate(<span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>rspeed)
      time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.8</span>)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>stop()

    <span style="color: #888888"># Set surface normal</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>calibrateSurfaceNormal()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>initSurface(p1i, p2i, p3i)
    <span style="color: #008800; font-weight: bold">print</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>surfaceNormal

    <span style="color: #888888"># Set starting position</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>position, <span style="color: #007020">self</span><span style="color: #333333">.</span>direction <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>surfaceMap(p1i, p2i, p3i)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrated <span style="color: #333333">=</span> <span style="color: #007020">True</span>

  <span style="color: #888888"># Determines the plane of the paper in 3D space</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">calibrate</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrated:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Skipping calibration.&quot;</span>
      <span style="color: #008800; font-weight: bold">return</span>

    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Establishing start position...&quot;</span>
    start <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
    <span style="color: #008800; font-weight: bold">while</span> start <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
      start <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
    p1i, p2i, p3i <span style="color: #333333">=</span> start
    <span style="color: #008800; font-weight: bold">print</span> start

    <span style="color: #888888"># Calibrate surface normal</span>
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Calibrating surface normal...&quot;</span>
    
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">inBoundary</span>(points):
      x, y <span style="color: #333333">=</span> points[<span style="color: #0000DD; font-weight: bold">1</span>]
      framex, framey <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>framex, <span style="color: #007020">self</span><span style="color: #333333">.</span>framey
      top <span style="color: #333333">=</span> y <span style="color: #333333">&gt;</span> framey <span style="color: #333333">*</span> pmap<span style="color: #333333">.</span>IMG_HEIGHT
      bottom <span style="color: #333333">=</span> y <span style="color: #333333">&lt;</span> (<span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">-</span> framey) <span style="color: #333333">*</span> pmap<span style="color: #333333">.</span>IMG_HEIGHT
      left <span style="color: #333333">=</span> x <span style="color: #333333">&gt;</span> framex <span style="color: #333333">*</span> pmap<span style="color: #333333">.</span>IMG_WIDTH
      right <span style="color: #333333">=</span> x <span style="color: #333333">&lt;</span> (<span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">-</span> framex) <span style="color: #333333">*</span> pmap<span style="color: #333333">.</span>IMG_WIDTH
      <span style="color: #008800; font-weight: bold">return</span> top <span style="color: #000000; font-weight: bold">and</span> bottom <span style="color: #000000; font-weight: bold">and</span> left <span style="color: #000000; font-weight: bold">and</span> right

    <span style="color: #888888"># Hit the boundary 5 times</span>
    hit <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    <span style="color: #008800; font-weight: bold">while</span> hit <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">5</span>:

      <span style="color: #888888"># Get points</span>
      points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
      <span style="color: #008800; font-weight: bold">while</span> points <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()

      <span style="color: #888888"># Keep going forward until a boundary is hit</span>
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>forward(<span style="color: #007020">self</span><span style="color: #333333">.</span>fspeed)
      starttime <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
      <span style="color: #008800; font-weight: bold">while</span> time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> starttime <span style="color: #333333">&lt;</span> <span style="color: #6600EE; font-weight: bold">0.9</span> <span style="color: #000000; font-weight: bold">or</span> inBoundary(points):
        p1, p2, p3 <span style="color: #333333">=</span> points
        <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>addCalibration(p1, p2, p3)
        points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
        <span style="color: #008800; font-weight: bold">while</span> points <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
          points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()

      <span style="color: #888888"># Rotate for some time</span>
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>rotate(<span style="color: #333333">-</span><span style="color: #007020">self</span><span style="color: #333333">.</span>rspeed)
      starttime <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
      <span style="color: #008800; font-weight: bold">while</span> time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> starttime <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">1</span>:
        p1, p2, p3 <span style="color: #333333">=</span> points
        <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>addCalibration(p1, p2, p3)
        points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
        <span style="color: #008800; font-weight: bold">while</span> points <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
          points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()

      hit <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>

    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>stop()

    <span style="color: #888888"># Set surface normal</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>calibrateSurfaceNormal()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>initSurface(p1i, p2i, p3i)
    <span style="color: #008800; font-weight: bold">print</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>surfaceNormal

    <span style="color: #888888"># Set starting position</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>position, <span style="color: #007020">self</span><span style="color: #333333">.</span>direction <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>surfaceMap(p1i, p2i, p3i)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrated <span style="color: #333333">=</span> <span style="color: #007020">True</span>

    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Finished!&quot;</span>

  <span style="color: #888888"># Sets up the PMap module by determining the surface normal</span>
  <span style="color: #888888"># and sets the initial position and direction of the bot.</span>
  <span style="color: #888888"># Calibrate without the bot.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">calibrateManual</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrated:
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Skipping calibration.&quot;</span>
      <span style="color: #008800; font-weight: bold">return</span>

    <span style="color: #888888"># Get start position</span>
    start <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
    <span style="color: #008800; font-weight: bold">while</span> start <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
      start <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
    p1i, p2i, p3i <span style="color: #333333">=</span> start

    <span style="color: #888888"># Calibrate PMap by providing a sample of coordinates</span>
    ts <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
    <span style="color: #008800; font-weight: bold">while</span> time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> ts <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">10</span>:
      pos <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
      <span style="color: #008800; font-weight: bold">if</span> pos <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        <span style="color: #008800; font-weight: bold">continue</span>
      p1, p2, p3 <span style="color: #333333">=</span> pos
      <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>addCalibration(p1, p2, p3)
      
    <span style="color: #888888"># Set surface normal</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>calibrateSurfaceNormal()
    <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>initSurface(p1i, p2i, p3i)

    <span style="color: #888888"># Set position and direction of the bot</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>position, <span style="color: #007020">self</span><span style="color: #333333">.</span>direction <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>surfaceMap(p1i, p2i, p3i)
    <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrated <span style="color: #333333">=</span> <span style="color: #007020">True</span>

  <span style="color: #888888"># Continually prints out the 2D position of the bot on the surface.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">printVector</span>(<span style="color: #007020">self</span>):
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
      points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
      <span style="color: #008800; font-weight: bold">if</span> points <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
        <span style="color: #008800; font-weight: bold">continue</span>
      p1, p2, p3 <span style="color: #333333">=</span> points
      pos, d <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>surfaceMapFast(p1, p2, p3)
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;(</span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">, </span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">)&quot;</span> <span style="color: #333333">%</span> (pos<span style="color: #333333">.</span>x, pos<span style="color: #333333">.</span>y), <span style="background-color: #fff0f0">&quot;(</span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">, </span><span style="background-color: #eeeeee">%f</span><span style="background-color: #fff0f0">)&quot;</span> <span style="color: #333333">%</span> (d<span style="color: #333333">.</span>x, d<span style="color: #333333">.</span>y)

  <span style="color: #888888"># Sets the 2D position and direction of the robot.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">setVector</span>(<span style="color: #007020">self</span>):
    start <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
    <span style="color: #008800; font-weight: bold">while</span> start <span style="color: #333333">==</span> <span style="color: #007020">None</span>:
      start <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>imageprocessor<span style="color: #333333">.</span>getPoints()
    p1i, p2i, p3i <span style="color: #333333">=</span> start
    <span style="color: #007020">self</span><span style="color: #333333">.</span>position, <span style="color: #007020">self</span><span style="color: #333333">.</span>direction <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>surfaceMapFast(p1i, p2i, p3i)

  <span style="color: #888888"># Moves the bot to a certain target coordinate.</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">gotoTarget</span>(<span style="color: #007020">self</span>, target, draw<span style="color: #333333">=</span><span style="color: #007020">False</span>):
    <span style="color: #888888"># Rotate bot towards the target</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>setVector()
    targetDirection <span style="color: #333333">=</span> (target <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>position)<span style="color: #333333">.</span>normalize()
    <span style="color: #008800; font-weight: bold">while</span> math<span style="color: #333333">.</span>acos(<span style="color: #007020">self</span><span style="color: #333333">.</span>direction <span style="color: #333333">*</span> targetDirection) <span style="color: #333333">&gt;</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>epst <span style="color: #000000; font-weight: bold">or</span> targetDirection<span style="color: #333333">.</span>cross(<span style="color: #007020">self</span><span style="color: #333333">.</span>direction) <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">0</span>:
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>rotate(<span style="color: #007020">self</span><span style="color: #333333">.</span>rspeed)
      <span style="color: #007020">self</span><span style="color: #333333">.</span>setVector()
      targetDirection <span style="color: #333333">=</span> (target <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>position)<span style="color: #333333">.</span>normalize()

    <span style="color: #888888"># Rotate in small steps until just passed</span>
    <span style="color: #008800; font-weight: bold">while</span> targetDirection<span style="color: #333333">.</span>cross(<span style="color: #007020">self</span><span style="color: #333333">.</span>direction) <span style="color: #333333">&gt;</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>epss:
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>rotateAdjust(<span style="color: #007020">self</span><span style="color: #333333">.</span>raspeed)
      <span style="color: #007020">self</span><span style="color: #333333">.</span>setVector()
      targetDirection <span style="color: #333333">=</span> (target <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>position)<span style="color: #333333">.</span>normalize()
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Rotation error:&quot;</span>, targetDirection<span style="color: #333333">.</span>cross(<span style="color: #007020">self</span><span style="color: #333333">.</span>direction)

    <span style="color: #888888"># Put pen down or up</span>
    <span style="color: #008800; font-weight: bold">if</span> draw <span style="color: #000000; font-weight: bold">and</span> <span style="color: #000000; font-weight: bold">not</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>pen:
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penDown(<span style="color: #007020">self</span><span style="color: #333333">.</span>dnspeed)
    <span style="color: #008800; font-weight: bold">elif</span> <span style="color: #000000; font-weight: bold">not</span> draw <span style="color: #000000; font-weight: bold">and</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>pen:
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penUp(<span style="color: #007020">self</span><span style="color: #333333">.</span>upspeed)

    <span style="color: #888888"># Move towards target point</span>
    flag <span style="color: #333333">=</span> <span style="color: #007020">False</span>
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>position<span style="color: #333333">.</span>dist_to(target) <span style="color: #333333">&gt;</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>epsxy:
      <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> flag:
        <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>forward(<span style="color: #007020">self</span><span style="color: #333333">.</span>fspeed)
        flag <span style="color: #333333">=</span> <span style="color: #007020">True</span>

      <span style="color: #888888"># Get direction vector to target</span>
      <span style="color: #007020">self</span><span style="color: #333333">.</span>setVector()
      targetDirection <span style="color: #333333">=</span> (target <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>position)<span style="color: #333333">.</span>normalize()
      
      <span style="color: #888888"># Calculate error</span>
      angle <span style="color: #333333">=</span> math<span style="color: #333333">.</span>acos(targetDirection <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>direction)
      sign <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #008800; font-weight: bold">if</span> targetDirection<span style="color: #333333">.</span>cross(<span style="color: #007020">self</span><span style="color: #333333">.</span>direction) <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #008800; font-weight: bold">else</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>
      scale <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>P
      att <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>position<span style="color: #333333">.</span>dist_to(target)

      <span style="color: #888888"># Adjust trajectory based on error</span>
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>adjust(sign <span style="color: #333333">*</span> scale <span style="color: #333333">*</span> angle)

    <span style="color: #888888"># Move towards target in small increments until just passed</span>
    <span style="color: #008800; font-weight: bold">while</span> targetDirection <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>direction <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>:
      <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>forwardAdjust(<span style="color: #007020">self</span><span style="color: #333333">.</span>fspeed)
      <span style="color: #007020">self</span><span style="color: #333333">.</span>setVector()
      targetDirection <span style="color: #333333">=</span> (target <span style="color: #333333">-</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>position)<span style="color: #333333">.</span>normalize()
      <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Position error:&quot;</span>, targetDirection <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>direction
    
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>stop()

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">drawPoints</span>(<span style="color: #007020">self</span>, points):
    <span style="color: #888888"># Calibrate pmap for the surface normal</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>calibrateRoutine()
    
    <span style="color: #888888"># Convert points</span>
    points <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>pmap<span style="color: #333333">.</span>mapPicture(points)

    <span style="color: #888888"># Draw points one by one</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>gotoTarget(points[<span style="color: #0000DD; font-weight: bold">0</span>])
    <span style="color: #007020">self</span><span style="color: #333333">.</span>gotoTarget(points[<span style="color: #0000DD; font-weight: bold">0</span>])
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">1</span>, <span style="color: #007020">len</span>(points)):
      <span style="color: #007020">self</span><span style="color: #333333">.</span>gotoTarget(points[i], draw<span style="color: #333333">=</span><span style="color: #007020">True</span>)
    
    <span style="color: #888888"># Put the pen back up</span>
    <span style="color: #007020">self</span><span style="color: #333333">.</span>bot<span style="color: #333333">.</span>penUp(<span style="color: #007020">self</span><span style="color: #333333">.</span>upspeed)
</pre></td></tr></table></div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888"># ui.py</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Draws the ui on the screen and handles user input</span>
<span style="color: #888888"># as well as outputing an array of screen coordinates.</span>

<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">sys</span><span style="color: #333333">,</span> <span style="color: #0e84b5; font-weight: bold">time</span><span style="color: #333333">,</span> <span style="color: #0e84b5; font-weight: bold">pygame</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">math</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">RPi.GPIO</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">GPIO</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">controller</span> <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">*</span>

<span style="color: #888888"># setup environment variables</span>
os<span style="color: #333333">.</span>putenv(<span style="background-color: #fff0f0">&#39;SDL_VIDEODRIVER&#39;</span>, <span style="background-color: #fff0f0">&#39;fbcon&#39;</span>) <span style="color: #888888"># Display on piTFT</span>
os<span style="color: #333333">.</span>putenv(<span style="background-color: #fff0f0">&#39;SDL_FBDEV&#39;</span>, <span style="background-color: #fff0f0">&#39;/dev/fb1&#39;</span>)
os<span style="color: #333333">.</span>putenv(<span style="background-color: #fff0f0">&#39;SDL_MOUSEDRV&#39;</span>, <span style="background-color: #fff0f0">&#39;TSLIB&#39;</span>)    <span style="color: #888888"># Track mouse clicks</span>
os<span style="color: #333333">.</span>putenv(<span style="background-color: #fff0f0">&#39;SDL_MOUSEDEV&#39;</span>, <span style="background-color: #fff0f0">&#39;/dev/input/touchscreen&#39;</span>)

<span style="color: #888888"># initialize GPIO pins</span>
GPIO<span style="color: #333333">.</span>setmode(GPIO<span style="color: #333333">.</span>BCM)
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">17</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">22</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">23</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">27</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)

<span style="color: #888888"># initialize pygame</span>
pygame<span style="color: #333333">.</span>init()
pygame<span style="color: #333333">.</span>mouse<span style="color: #333333">.</span>set_visible(<span style="color: #007020">True</span>)

size <span style="color: #333333">=</span> width, height <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">320</span>, <span style="color: #0000DD; font-weight: bold">240</span>
black <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>
white <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>

screen <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>set_mode(size)
my_font <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>font<span style="color: #333333">.</span>Font(<span style="color: #007020">None</span>, <span style="color: #0000DD; font-weight: bold">25</span>)

distance <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">62</span>

<span style="color: #888888"># clear button</span>
sqr_surface <span style="color: #333333">=</span> my_font<span style="color: #333333">.</span>render(<span style="background-color: #fff0f0">&quot;Clear&quot;</span>, <span style="color: #007020">True</span>, black)
sqr_pos <span style="color: #333333">=</span> sqr_x, left_y <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">290</span>, <span style="color: #0000DD; font-weight: bold">40</span>
sqr_rect <span style="color: #333333">=</span> sqr_surface<span style="color: #333333">.</span>get_rect(center<span style="color: #333333">=</span>sqr_pos)

<span style="color: #888888"># quit button</span>
sq_surface <span style="color: #333333">=</span> my_font<span style="color: #333333">.</span>render(<span style="background-color: #fff0f0">&quot;Quit&quot;</span>, <span style="color: #007020">True</span>, black)
sq_rect <span style="color: #333333">=</span> sq_surface<span style="color: #333333">.</span>get_rect(center<span style="color: #333333">=</span>sqr_pos)

<span style="color: #888888"># done button</span>
done_surface <span style="color: #333333">=</span> my_font<span style="color: #333333">.</span>render(<span style="background-color: #fff0f0">&quot;Done&quot;</span>, <span style="color: #007020">True</span>, black)
done_pos <span style="color: #333333">=</span> done_x, done_y <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">290</span>, <span style="color: #0000DD; font-weight: bold">40</span> <span style="color: #333333">+</span> distance
done_rect <span style="color: #333333">=</span> done_surface<span style="color: #333333">.</span>get_rect(center<span style="color: #333333">=</span>done_pos)

<span style="color: #888888"># undo button</span>
undo_surface <span style="color: #333333">=</span> my_font<span style="color: #333333">.</span>render(<span style="background-color: #fff0f0">&quot;Undo&quot;</span>, <span style="color: #007020">True</span>, black)
undo_pos <span style="color: #333333">=</span> undo_x, undo_y <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">290</span>, <span style="color: #0000DD; font-weight: bold">40</span> <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">2</span><span style="color: #333333">*</span>distance
undo_rect <span style="color: #333333">=</span> undo_surface<span style="color: #333333">.</span>get_rect(center<span style="color: #333333">=</span>undo_pos)

<span style="color: #888888"># redo button</span>
redo_surface <span style="color: #333333">=</span> my_font<span style="color: #333333">.</span>render(<span style="background-color: #fff0f0">&quot;Redo&quot;</span>, <span style="color: #007020">True</span>, black)
redo_pos <span style="color: #333333">=</span> redo_x, redo_y <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">290</span>, <span style="color: #0000DD; font-weight: bold">40</span> <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">3</span><span style="color: #333333">*</span>distance
redo_rect <span style="color: #333333">=</span> redo_surface<span style="color: #333333">.</span>get_rect(center<span style="color: #333333">=</span>redo_pos)

<span style="color: #888888"># main loop</span>
show_buttons <span style="color: #333333">=</span> <span style="color: #007020">True</span> 
points <span style="color: #333333">=</span> []
pointsredo <span style="color: #333333">=</span> []
start <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
c <span style="color: #333333">=</span> Controller()
timer <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
<span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
  <span style="color: #888888"># clear/quit button</span>
  <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">17</span>):
    <span style="color: #008800; font-weight: bold">if</span> points <span style="color: #333333">==</span> []:
      <span style="color: #008800; font-weight: bold">break</span>
    points <span style="color: #333333">=</span> []
    pointsredo <span style="color: #333333">=</span> []
    time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.2</span>)

  <span style="color: #888888"># done button</span>
  <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">22</span>):
    c<span style="color: #333333">.</span>drawPoints(points[::<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>])

  <span style="color: #888888"># undo button</span>
  <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">23</span>):
    <span style="color: #008800; font-weight: bold">if</span> points <span style="color: #333333">!=</span> []:
      pointsredo <span style="color: #333333">=</span> [points[<span style="color: #0000DD; font-weight: bold">0</span>]] <span style="color: #333333">+</span> pointsredo
      <span style="color: #008800; font-weight: bold">del</span> points[<span style="color: #0000DD; font-weight: bold">0</span>]
    time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.2</span>)

  <span style="color: #888888"># redo button</span>
  <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">27</span>):
    <span style="color: #008800; font-weight: bold">if</span> pointsredo <span style="color: #333333">!=</span> []:
      points <span style="color: #333333">=</span> [pointsredo[<span style="color: #0000DD; font-weight: bold">0</span>]] <span style="color: #333333">+</span> points
      <span style="color: #008800; font-weight: bold">del</span> pointsredo[<span style="color: #0000DD; font-weight: bold">0</span>]
    time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.2</span>)

  <span style="color: #888888"># drawing points</span>
  <span style="color: #008800; font-weight: bold">for</span> event <span style="color: #000000; font-weight: bold">in</span> pygame<span style="color: #333333">.</span>event<span style="color: #333333">.</span>get():
    <span style="color: #008800; font-weight: bold">if</span> event<span style="color: #333333">.</span>type <span style="color: #333333">==</span> pygame<span style="color: #333333">.</span>QUIT:
      sys<span style="color: #333333">.</span>exit()
    <span style="color: #008800; font-weight: bold">if</span> event<span style="color: #333333">.</span>type <span style="color: #333333">==</span> pygame<span style="color: #333333">.</span>MOUSEBUTTONUP:
      show_buttons <span style="color: #333333">=</span> <span style="color: #007020">False</span>
      timer <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">100</span>
      x, y <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>mouse<span style="color: #333333">.</span>get_pos()
      dist <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">20</span>
      <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> points:
        xi, yi <span style="color: #333333">=</span> i
        <span style="color: #008800; font-weight: bold">if</span> ((xi <span style="color: #333333">-</span> x)<span style="color: #333333">**</span><span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">+</span> (yi <span style="color: #333333">-</span> y)<span style="color: #333333">**</span><span style="color: #0000DD; font-weight: bold">2</span>)<span style="color: #333333">**.</span><span style="color: #0000DD; font-weight: bold">5</span> <span style="color: #333333">&lt;</span> dist:
          x, y <span style="color: #333333">=</span> xi, yi
          <span style="color: #008800; font-weight: bold">break</span>
      points <span style="color: #333333">=</span> [(x, y)] <span style="color: #333333">+</span> points
      pointsredo <span style="color: #333333">=</span> []
      <span style="color: #008800; font-weight: bold">print</span> x, y
  
  <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> show_buttons:
    <span style="color: #008800; font-weight: bold">if</span> timer <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>:
      show_buttons <span style="color: #333333">=</span> <span style="color: #007020">True</span>
    timer <span style="color: #333333">-=</span> <span style="color: #0000DD; font-weight: bold">1</span>

  <span style="color: #888888"># draw the screen</span>
  screen<span style="color: #333333">.</span>fill(white)
  <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> points:
    pygame<span style="color: #333333">.</span>draw<span style="color: #333333">.</span>circle(screen, black, i, <span style="color: #0000DD; font-weight: bold">2</span>)
  <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">len</span>(points) <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">1</span>:
    pygame<span style="color: #333333">.</span>draw<span style="color: #333333">.</span>lines(screen, black, <span style="color: #007020">False</span>, points, <span style="color: #0000DD; font-weight: bold">2</span>)
    
  <span style="color: #008800; font-weight: bold">if</span> show_buttons:
    <span style="color: #008800; font-weight: bold">if</span> points <span style="color: #333333">==</span> []:
      screen<span style="color: #333333">.</span>blit(sq_surface, sq_rect)
    <span style="color: #008800; font-weight: bold">else</span>:
      screen<span style="color: #333333">.</span>blit(sqr_surface, sqr_rect)
    screen<span style="color: #333333">.</span>blit(done_surface, done_rect)
    screen<span style="color: #333333">.</span>blit(undo_surface, undo_rect)
    screen<span style="color: #333333">.</span>blit(redo_surface, redo_rect)
  pygame<span style="color: #333333">.</span>display<span style="color: #333333">.</span>flip()

  time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.01</span>)

GPIO<span style="color: #333333">.</span>cleanup()
sys<span style="color: #333333">.</span>exit()
</pre></td></tr></table></div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888"># mainrx.py</span>
<span style="color: #888888">#</span>
<span style="color: #888888"># Main module that runs on the bot that continually</span>
<span style="color: #888888"># tries to connect. Once connected, it executes </span>
<span style="color: #888888"># any received commands.</span>

<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">wireless</span> <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">*</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>

bot <span style="color: #333333">=</span> VirtualBotRX()
<span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
  time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">3</span>)
  <span style="color: #008800; font-weight: bold">try</span>:
    bot<span style="color: #333333">.</span>connect()
    bot<span style="color: #333333">.</span>run()
  <span style="color: #008800; font-weight: bold">except</span> socket<span style="color: #333333">.</span>error:
    <span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&#39;Trying to connect...&#39;</span>
</pre></td></tr></table></div>  

    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script> -->
  </body>
</html>
